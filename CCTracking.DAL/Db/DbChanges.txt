-----------------------------CHANGES FROM JAN-10-2015 ----------------------------
GetRceiptContentById
AdminSummary_View
GetAllBooking
[SaveBooking]
[SaveBusVisit]
[Audit_BusVisit]
[dbo].[fn_audit_BusVisit]
[dbo].[GetNearestCentreById]
[rptDashboardBookingSummary]

------------------ CHANGES FROM JAN-08-2015 ----------------------------

ALTER PROCEDURE [dbo].[SaveBooking]            
@Id int=null,        
@ContactName nvarchar(100),      
@ContactMobile nvarchar(100),      
@ContactNic nvarchar(100)=null,      
@DeseasedName nvarchar(100)=null,      
@DeseasedAge smallint=null,      
@DeseasedGender smallint=null,      
@CauseOfDeath smallint=null,      
@Address varchar(50)=null,      
@BusPoint int =null,      
@LandmarkId int =null,      
@UnionCouncilId int =null,      
@TownId int =null,      
@PickupDate datetime =null,      
@PickupTime smallint =null,      
@ReturnTime smallint =null,      
@GraveyardId smallint=null,      
@NamazEJanazaHeldIn smallint=null,       
@NamazEJanazaLocation nvarchar(100)=null,      
@MasjidName nvarchar(100)=null,
@IsReferralBooking bit = null,
@ReferralName nvarchar(100)=  null,
@ReferralDetail nvarchar(400)= null,
@OtherDetail nvarchar(400)=null,  
@alkhidmatCentre int,
@CreatedBy int,  
@ModifiedBy int,  
@ModifiedDate datetime,  
@IsActive bit=1      
as            
        
IF @Id=null or @Id=0        
BEGIN        
 INSERT INTO Booking(ContactName,ContactMobile,ContactNic,DeseasedName,DeseasedAge,DeseasedGender,CauseOfDeath,Address,BusPoint,LandmarkId,UnionCouncilId,TownId,PickupDate,PickupTime,ReturnTime,GraveyardId,NamazEJanazaHeldIn,NamazEJanazaLocation,MasjidName,IsReferralBooking,ReferralName, ReferralDetail, OtherDetail,alkhidmatCentre,CreatedBy,ModifiedBy,ModifiedDate)         
         
 VALUES(@ContactName,@ContactMobile,@ContactNic,@DeseasedName,@DeseasedAge,@DeseasedGender,@CauseOfDeath,@Address,@BusPoint,@LandmarkId,@UnionCouncilId,@TownId,@PickupDate,@PickupTime,@ReturnTime,@GraveyardId,@NamazEJanazaHeldIn,@NamazEJanazaLocation,@MasjidName,@IsReferralBooking, @ReferralName, @ReferralDetail, @OtherDetail,@alkhidmatCentre,@CreatedBy,@ModifiedBy,@ModifiedDate)            
 select * from Booking where id=SCOPE_IDENTITY()         
END        
ELSE         
BEGIN        
 UPDATE Booking SET        
 ContactName = @ContactName,        
 ContactMobile=@ContactMobile,        
 ContactNic=@ContactNic,        
 DeseasedName=@DeseasedName,        
 DeseasedAge=@DeseasedAge,        
 DeseasedGender=@DeseasedGender,        
 CauseOfDeath=@CauseOfDeath,        
 Address=@Address,        
 BusPoint=@BusPoint,        
 LandmarkId=@LandmarkId,        
 UnionCouncilId=@UnionCouncilId,        
 TownId=@TownId,        
 PickupDate=@PickupDate,    
 PickupTime=@PickupTime,        
 ReturnTime=@ReturnTime,        
 GraveyardId=@GraveyardId,        
 NamazEJanazaHeldIn=@NamazEJanazaHeldIn,      
NamazEJanazaLocation=@NamazEJanazaLocation,      
MasjidName=@MasjidName,    
IsReferralBooking= @IsReferralBooking,
ReferralName =  @ReferralName,
ReferralDetail  = @ReferralDetail,  
OtherDetail=@OtherDetail,  
alkhidmatCentre = @alkhidmatCentre,
ModifiedBy=@ModifiedBy,  
ModifiedDate=@ModifiedDate  
 WHERE Id=@Id        
 
 update BusVisit set VisitDate=@PickupDate,OutTime=@PickupTime,ReturnTime=@ReturnTime where BookingId=@Id
 --from Booking b inner join BusVisit bv on b.Id=bv.BookingId            
 
 select * from Booking where id=@Id     
            
end     
  

ALTER procedure [dbo].[SaveBusVisit]                  
@Id int,                  
@CentreId int,                  
@BusId int,                  
@DriverId int,                  
@VisitTypeId int,                  
@BookingId int,                  
@InchargeName nvarchar(30)=null,                
@VisitDate DateTime=null,                
@OutTime tinyint,                
@ReturnTime tinyint,        
@ReturnDate datetime=null,              
@ReadingWhenFilling bigint,                
@PumpLocation nvarchar(50)=null,                
@FuelRate money,                
@FuelAmount money,                
@IsBookingCompleted bit,                  
@InitialReading bigint,                  
@FinalReading bigint,           
@FuelQuantity money,   
@FuelingReceipt nvarchar(50)=null,                
@Description nvarchar(300)=null,                
@IsActive bit,                  
@CreatedBy int,                  
@ModifiedBy int,                  
@ModifiedDate datetime                  
                  
as                  
begin              
declare @newId int      
declare @visitCount int    
    
    
if @Id is not null and @Id > 0                  
 begin              
 set @newId=@Id                
 update [BusVisit]                  
 set                   
 CentreId = @CentreId,BusId = @BusId,DriverId = @DriverId,VisitTypeId=  @VisitTypeId,BookingId = @BookingId, InchargeName=@InchargeName,VisitDate=@VisitDate,OutTime=@OutTime,ReturnTime=@ReturnTime,ReturnDate=@ReturnDate,ReadingWhenFilling=@ReadingWhenFilling,  
PumpLocation=@PumpLocation,FuelRate=@FuelRate,FuelAmount=@FuelAmount,IsBookingCompleted=@IsBookingCompleted, InitialReading = @InitialReading,FinalReading= @FinalReading,Description=@Description,IsActive = @IsActive,CreatedBy = @CreatedBy,ModifiedBy = @ModifiedBy,ModifiedDate = @ModifiedDate, FuelQuantity = @FuelQuantity , Receipt = @FuelingReceipt         
 where id = @Id                   
 end                   
 else                  
 begin                  
 select @visitCount=COUNT(id) from BusVisit where BusId=@BusId    
 if @visitCount=0     
 begin    
 select @InitialReading= InitialReading from Bus where id=@BusId    
 end    
 insert into BusVisit                  
 (CentreId,BusId,DriverId,VisitTypeId,BookingId,InchargeName,VisitDate,OutTime,ReturnTime,ReturnDate,ReadingWhenFilling,PumpLocation,FuelRate,FuelAmount,IsBookingCompleted,InitialReading,FinalReading,Description,CreatedBy,ModifiedBy,ModifiedDate,FuelQuantity, Receipt)                 
           
 values                  
 (@CentreId,@BusId,@DriverId,@VisitTypeId,@BookingId,@InchargeName,@VisitDate,@OutTime,@ReturnTime,@ReturnDate,@ReadingWhenFilling,@PumpLocation,@FuelRate,@FuelAmount,@IsBookingCompleted,@InitialReading,@FinalReading,@Description,@CreatedBy,@ModifiedBy,@ModifiedDate,@FuelQuantity, @FuelingReceipt)          
              
 set @newId=SCOPE_IDENTITY()            
            
end                  
            
--update BusVisit set FinalReading=@ReadingWhenFilling where id=(select top 1 id from BusVisit where id<>@newId and BusId=@BusId order by VisitDate desc,CreatedDate desc)            
update BusVisit set BusStatus=3 where id=@newId            
--update BusVisit set VisitDate=b.PickupDate,OutTime=b.PickupTime,ReturnTime=b.ReturnTime from Booking b inner join BusVisit bv on b.Id=bv.BookingId            
update booking set PickupDate=@VisitDate,PickupTime=@OutTime,ReturnTime=@ReturnTime where Id=@BookingId
        
if @VisitTypeId=3         
begin        
 update Bus set IsOnMaintainance=1 where id=@BusId        
end        

if @VisitTypeId=3 and @IsBookingCompleted=1         
begin        
 update Bus set IsOnMaintainance=0 where id=@BusId        
end        
        
select bv.*,t.Name as VisitType ,b.VehicleNo as BusDesc,(d.FirstName + ' ' + d.LastName) as DriverDesc,a.Name as CentreDesc        
from BusVisit bv                   
inner join Bus b on b.Id=bv.BusId                  
inner join Driver d on d.Id=bv.DriverId                  
inner join AlkhidmatCentre a on a.Id=bv.CentreId                  
inner join VisitType t on t.Id=bv.VisitTypeId  where bv.Id = @newId             
            
end     
  go
