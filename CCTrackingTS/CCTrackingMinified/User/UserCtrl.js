var __extends=this.__extends||function(e,t){function s(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);s.prototype=t.prototype,e.prototype=new s};define(["require","exports","../App","../Helper","./UserView","../Dtos/UserDto","../DAL/User","marionette","jquery","knockout","text!./UserTmpl.html"],function(e,t,s,o,i,r,n){var l=e("underscore"),d=e("knockout"),a=e("knockback"),c=function(e){function t(){e.call(this),this.app=s.Application.getInstance(),this.backboneModel=new r.Models.UserDto,this.userViewModel=new i.UserViewModel(this.backboneModel,this),this.userView=new i.UserView({viewModel:this.userViewModel}),this.collection=new r.Models.UserCollection({}),this.collectionView=new i.UserCollectionView({collection:this.collection})}return __extends(t,e),t.prototype.Show=function(){var e=this,t=window.location.href;if(t.indexOf("id=")>-1){var s=t.substring(t.indexOf("id=")+3,t.length),o=n.GetById(s);o.done(function(t){return e.GetByIdCompleted(t)})}else this.Load()},t.prototype.Load=function(){var e=this,t=JSON.parse(localStorage.getItem("lookupResponse")),s=this.backboneModel;this.userViewModel.bbModel=s,this.userViewModel.model=a.viewModel(s),s.set("firstName",""),s.set("lastName",""),s.set("alkhidmatCentreList",t.alkhidmatCentre),s.set("alkhidmatCentreSelected",""),s.set("roleList",t.role),s.set("roleSelected",""),s.set("cnic",""),s.set("userName",""),s.set("address",""),s.set("city",""),s.set("mobile",""),s.set("email",""),s.set("isActive","1"),this.userViewModel=new i.UserViewModel(s,this),this.userView=new i.UserView({viewModel:this.userViewModel}),this.userView.on("SaveUser",function(){return e.Save(e.userViewModel.bbModel)}),this.userView.on("CancelForm",function(){return e.Cancel()}),this.app.MainRegion.show(this.userView)},t.prototype.GetAll=function(){var e=this,t=n.GetAll();t.done(function(t){return e.GetAllCompleted(t)})},t.prototype.GetByIdCompleted=function(e){var t=this;this.backboneModel=new Backbone.Model(e);var s=this.backboneModel;this.UIBinding(s),this.userView=new i.UserView({viewModel:this.userViewModel}),this.userView.on("SaveUser",function(){return t.Save(t.userViewModel.bbModel)}),this.userView.on("CancelForm",function(){return t.Cancel()}),this.app.MainRegion.show(this.userView)},t.prototype.Save=function(e){var t=this,s=this.app.request("AppGlobalSetting");e.set("modifiedBy",s.get("Id")),e.set("centreId",e.get("alkhidmatCentreSelected").id),e.set("roleId",e.get("roleSelected").id),e.set("isActive","1"==e.get("isActive")?!0:!1);var o=n.Save(this.GetMinimalRequest(e));o.done(function(e){return t.SaveCompleted(e)})},t.prototype.GetMinimalRequest=function(e){var t=new r.Models.UserDto;return t.set("id",e.get("id")),t.set("firstName",e.get("firstName")),t.set("lastName",e.get("lastName")),t.set("email",e.get("email")),t.set("mobile",e.get("mobile")),t.set("cnic",e.get("cnic")),t.set("address",e.get("address")),t.set("city",e.get("city")),t.set("userName",e.get("userName")),t.set("password",e.get("password")),t.set("centreId",e.get("centreId")),t.set("roleId",e.get("roleId")),t.set("isAdmin",e.get("isAdmin")),t.set("isActive",e.get("isActive")),t.set("createdBy",e.get("createdBy")),t.set("createdDate",e.get("createdDate")),t.set("modifiedBy",e.get("modifiedBy")),t.set("modifiedDate",e.get("modifiedDate")),t},t.prototype.GetAllCompleted=function(e){var t=this;this.collection.reset(e),this.collectionView=new i.UserCollectionView({collection:this.collection}),this.collectionView.on("itemview:ShowDetail",function(e){return t.GetByIdCompleted(e.model)}),this.collectionView.listenTo(this.collectionView,"itemview:Event:ResetPassword",function(e,s){return t.ResetUserPassword(s)}),this.app.MainRegion.show(this.collectionView)},t.prototype.SaveCompleted=function(e){this.backboneModel=new Backbone.Model(e);this.backboneModel;void 0==e?o.ShowModalPopup("danger","User Detail","User Detail have not been saved successfully!"):(o.ShowModalPopup("success","User Detail","Record has been saved successfully with User ID : "+e.id),this.Cancel())},t.prototype.Cancel=function(){window.location.href="#viewUser"},t.prototype.ResetUserPassword=function(e){var t=this,s=this.app.request("AppGlobalSetting");e.set("modifiedBy",s.get("Id"));var o=n.ResetUserPasswrd(e);o.done(function(e){return t.ResetUserPasswrdCompleted(e)})},t.prototype.ResetUserPasswrdCompleted=function(e){var t=new Backbone.Model(e);return void 0==t?void o.ShowModalPopup("danger","Reset Password","Due to some technical reason password have not been reset successfully!<br> Pelase try later"):void 0!=t.get("errorMessage")&&""!=t.get("errorMessage").trim()?void o.ShowModalPopup("danger","Reset Password",t.get("errorMessage")):void o.ShowModalPopup("success","Reset Password","User Password has been reset successfully to his initial password.")},t.prototype.UIBinding=function(e){var t=JSON.parse(localStorage.getItem("lookupResponse"));e.set("alkhidmatCentreList",t.alkhidmatCentre);var s=l.filter(t.alkhidmatCentre,function(t){return t.id==e.get("centreId")});e.set("alkhidmatCentreSelected",s[0]),e.set("roleList",t.role);var o=l.filter(t.role,function(t){return t.id==e.get("roleId")});e.set("roleSelected",o[0]),e.set("isActive",e.get("isActive")?"1":"0"),this.userViewModel.bbModel=e,this.userViewModel.model=a.viewModel(e),d.cleanNode($(this.userView.el)[0]),d.applyBindings(this.userViewModel,this.userView.el)},t}(o.Controller);t.UserCtrl=c});