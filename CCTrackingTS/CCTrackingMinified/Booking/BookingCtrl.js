var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);i.prototype=t.prototype,e.prototype=new i};define(["require","exports","../App","../Helper","./BookingView","CCTracking.WebClient/Dtos/BookingDto","../DAL/Booking","marionette","jquery","knockout","selectize","text!./BookingTmpl.html"],function(e,t,i,n,o,a,s){var r,d=e("underscore"),l=(e("knockout"),e("selectize"),function(t){function l(){r=i.Application.getInstance(),t.call(this)}return __extends(l,t),l.prototype.Show=function(){this.LoadCompleted(JSON.parse(localStorage.getItem("lookupResponse")))},l.prototype.EditBooking=function(e){var t=this,i=s.GetById(e);i.done(function(e){return t.GetByIdCompleted(e)})},l.prototype.GetByIdCompleted=function(e){var t=this,i=JSON.parse(localStorage.getItem("lookupResponse")),a=new Backbone.Model(e.bookingModel);a.set("causeOfDeathList",i.causeOfDeath),a.set("landmarkList",i.landmark),a.set("busPointList",i.landmark),a.set("unionCouncilList",i.unionCouncil),a.set("townList",i.town),a.set("graveyardList",i.graveyard),a.set("busDetailsList",i.bus),a.set("pickupTimeSlotList",i.timeSlot),a.set("returnTimeSlotList",i.timeSlot),a.set("prayersList",i.prayers),a.set("prayersList",i.prayers),a.set("alkhidmatCentreList",i.alkhidmatCentre);var s=d.filter(i.causeOfDeath,function(e){return e.id==a.get("causeOfDeath")}),l=(d.filter(i.landmark,function(e){return e.id==a.get("landmarkId")}),d.filter(i.landmark,function(e){return e.id==a.get("busPoint")})),c=d.filter(i.unionCouncil,function(e){return e.id==a.get("unionCouncilId")}),u=d.filter(i.town,function(e){return e.id==a.get("townId")}),g=d.filter(i.graveyard,function(e){return e.id==a.get("graveyardId")}),p=d.filter(i.bus,function(e){return e.id==a.get("busDetailId")}),m=d.filter(i.timeSlot,function(e){return e.id==a.get("pickupTime")}),k=d.filter(i.timeSlot,function(e){return e.id==a.get("returnTime")}),f=d.filter(i.prayers,function(e){return e.id==a.get("namazEJanazaHeldIn")}),h=d.filter(i.alkhidmatCentre,function(e){return e.id==a.get("alkhidmatCentreId")});a.set("causeOfDeathSelected",s[0]),a.set("busPointSelected",l[0]),a.set("unionCouncilIdSelected",c[0]),a.set("townIdSelected",u[0]),a.set("graveyardIdSelected",g[0]),a.set("busDetailIdSelected",p[0]),a.set("deseasedGender",a.get("deseasedGender").toString()),a.set("alkhidmatCentreSelected",h[0]),a.set("pickupTimeSlotSelected",m[0]),a.set("returnTimeSlotSelected",k[0]),a.set("prayersSelected",f[0]),a.set("isReferralBooking",a.get("isReferralBooking")?"1":"0"),a.set("pickupDate",n.FormatDateString(a.get("pickupDate"))),this.bookingViewModel=new o.BookingViewModel(a,this),this.bookingView=new o.BookingView({viewModel:this.bookingViewModel}),this.bookingView.on("SaveBooking",function(){return t.Save(t.bookingViewModel.bbModel)}),this.layout=r.AppLayout,r.MainRegion.show(this.bookingView),void 0!=l[0]&&this.bookingView.$el.find("#txtBusPoint").append(l[0].description)},l.prototype.LoadCompleted=function(e){var t=this,i=new a.Models.BookingResponse;i.set("contactName",""),i.set("contactMobile",""),i.set("contactNic",""),i.set("deseasedName",""),i.set("deseasedAge",""),i.set("deseasedGender",""),i.set("causeOfDeathList",e.causeOfDeath),i.set("causeOfDeathSelected",""),i.set("address",""),i.set("landmarkIdSelected",""),i.set("landmarkList",e.landmark),i.set("busPointList",e.landmark),i.set("busPointSelected",""),i.set("alkhidmatCentreList",e.alkhidmatCentre),i.set("alkhidmatCentreSelected",""),i.set("unionCouncilList",e.unionCouncil),i.set("unionCouncilIdSelected",""),i.set("townList",e.town),i.set("townIdSelected",""),i.set("pickupDate",""),i.set("pickupTime",""),i.set("returnTime",""),i.set("graveyardList",e.graveyard),i.set("graveyardIdSelected",""),i.set("pickupTimeSlotList",e.timeSlot),i.set("pickupTimeSlotSelected",""),i.set("returnTimeSlotList",e.timeSlot),i.set("returnTimeSlotSelected",""),i.set("prayersList",e.prayers),i.set("prayersSelected",""),i.set("namazEJanazaHeldIn",""),i.set("namazEJanazaLocation",""),i.set("masjidName",""),i.set("otherDetail",""),i.set("isReferralBooking",""),i.set("referralName",""),i.set("referralDetail",""),this.bookingViewModel=new o.BookingViewModel(i,this),this.bookingView=new o.BookingView({viewModel:this.bookingViewModel}),this.bookingView.on("SaveBooking",function(){return t.Save(t.bookingViewModel.bbModel)}),this.layout=r.AppLayout,r.MainRegion.show(this.bookingView)},l.prototype.GetAll=function(e){var t=this;"undefined"==typeof e&&(e=1),void 0==e&&(e=1);var i=s.GetAll(e);i.done(function(e){return t.GetAllCompleted(e)})},l.prototype.GetAllCompleted=function(t){var s=this;r=i.Application.getInstance();var l=d.map(t.bookingList,function(e){return e.pickupDate="0001-01-01T00:00:00"!=e.pickupDate?n.FormatDateString(e.pickupDate):"",e}),c=new a.Models.BookingResponseCollection(l),u=new o.BookingCollectionView({collection:c});u.listenTo(u,"itemview:ExportToPdf",function(e,t){n.PrintReceipt(t)}),u.listenTo(u,"itemview:Event:EditBooking",function(e,t){s.EditBooking(t)}),u.listenTo(u,"itemview:Event:EditPayment",function(t,i){e(["./../Payment/PaymentCtrl"],function(e){(new e.PaymentCtrl).EditPayment(i)})}),u.listenTo(u,"itemview:Event:EditRefund",function(t,i){e(["./../RefundBooking/RefundBookingCtrl"],function(e){(new e.RefundBookingCtrl).EditRefund(i)})}),u.listenTo(u,"itemview:Event:EditExtraCharge",function(t,i){e(["./../ExtraCharge/ExtraChargeCtrl"],function(e){(new e.ExtraChargeCtrl).EditExtraCharge(i)})}),r.MainRegion.show(u)},l.prototype.Save=function(e){var t=this,i=r.request("AppGlobalSetting");if(e.set("modifiedBy",i.get("Id")),e.set("causeOfDeath",e.get("causeOfDeathSelected").id),e.set("busPoint",e.get("busPointSelected").id),e.set("unionCouncilId",e.get("unionCouncilIdSelected").id),e.set("townId",e.get("townIdSelected").id),e.set("graveyardId",e.get("graveyardIdSelected").id),e.set("pickupTime",e.get("pickupTimeSlotSelected").id),e.set("returnTime",e.get("returnTimeSlotSelected").id),e.set("namazEJanazaHeldIn",e.get("prayersSelected").id),e.set("alkhidmatCentreId",e.get("alkhidmatCentreSelected").id),"1"==e.get("isReferralBooking")&&0==e.get("referralName").trim().length)return void n.ShowModalPopup("danger","Booking","Please enter referral name.");e.set("isReferralBooking","1"==e.get("isReferralBooking")?!0:!1);var o=s.Save(this.GetMinimalRequest(e));o.done(function(e){t.SaveCompleted(e)})},l.prototype.GetMinimalRequest=function(e){var t=new a.Models.BookingRequest;return t.set("alkhidmatCentreId",e.get("alkhidmatCentreId")),t.set("address",e.get("address")),t.set("busPoint",e.get("busPoint")),t.set("causeOfDeath",e.get("causeOfDeath")),t.set("contactMobile",e.get("contactMobile")),t.set("contactName",e.get("contactName")),t.set("contactNic",e.get("contactNic")),t.set("createdBy",e.get("createdBy")),t.set("createdDate",e.get("createdDate")),t.set("deseasedAge",e.get("deseasedAge")),t.set("deseasedGender",e.get("deseasedGender")),t.set("deseasedName",e.get("deseasedName")),t.set("graveyardId",e.get("graveyardId")),t.set("id",e.get("id")),t.set("isActive",e.get("isActive")),t.set("isReferralBooking",e.get("isReferralBooking")),t.set("landmarkId",e.get("landmarkId")),t.set("masjidName",e.get("masjidName")),t.set("modifiedBy",e.get("modifiedBy")),t.set("modifiedDate",e.get("modifiedDate")),t.set("namazEJanazaHeldIn",e.get("namazEJanazaHeldIn")),t.set("namazEJanazaLocation",e.get("namazEJanazaLocation")),t.set("operationType",e.get("operationType")),t.set("otherDetail",e.get("otherDetail")),t.set("pickupDate",e.get("pickupDate")),t.set("pickupTime",e.get("pickupTime")),t.set("referralDetail",e.get("referralDetail")),t.set("referralName",e.get("referralName")),t.set("returnTime",e.get("returnTime")),t.set("townId",e.get("townId")),t.set("unionCouncilId",e.get("unionCouncilId")),t},l.prototype.SaveCompleted=function(t){var i=new Backbone.Model(t);void 0!=i.get("errorMessage")&&""!=i.get("errorMessage").trim()?(console.log(i.get("errorMessage")),n.ShowModalPopup("danger","Booking","Due to some technical reason booking have not been saved successfully!<br> Pelase try later")):(n.ShowModalPopup("success","Booking","Record has been saved successfully with Booking ID : "+t.id),e(["./../Payment/PaymentCtrl"],function(e){(new e.PaymentCtrl).EditPayment(i.get("id"))}))},l}(n.Controller));t.BookingCtrl=l});