var __extends=this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);o.prototype=t.prototype,e.prototype=new o};define(["require","exports","../../../../App","../../../../Helper","./BusCentreReportView","../../../../Dtos/BookingSummaryDto","../../../../Dtos/ReportDto","../../../../DAL/BusCentreReport","marionette","jquery","knockout"],function(e,t,o,i,n,r,a,s){var l=(e("underscore"),e("knockout")),c=e("knockback"),u=function(e){function t(){e.call(this),this.app=o.Application.getInstance(),this.backboneModel=new r.Models.BookingSummaryDto,this.searchViewModel=new n.SearchViewModel(this.backboneModel,this),this.compositeModel=new Backbone.Model,this.backboneCollection=new Backbone.Collection([]),this.collectionView=new n.SearchCollectionView({collection:this.backboneCollection,model:this.compositeModel}),this.backboneCollection.reset([])}return __extends(t,e),t.prototype.Show=function(){this.Load()},t.prototype.Load=function(){var e=this,t=this.backboneModel,o=this.app.request("ReportFilterSetting");t.set("fromBookingDate",o.get("fromDate")),t.set("toBookingDate",o.get("toDate")),t.set("centreId",o.get("centreId")),this.compositeModel=t,this.collectionView.listenTo(this.collectionView,"BusCentreReport",function(){return e.GetByCriteria(e.searchViewModel.bbModel)}),this.collectionView.listenTo(this.collectionView,"itemview:BusVisitDetails",function(o,i){e.ShowBusVisitDetails(i,t)}),this.collectionView.on("CancelForm",function(){return e.Cancel()}),this.app.MainRegion.show(this.collectionView);var i=c.viewModel(this.compositeModel),n=$("#txtFromBookingDate")[0];l.cleanNode(n),l.applyBindings(i,n);var a=$("#txtToBookingDate")[0];l.cleanNode(a),l.applyBindings(i,a);var u=new r.Models.BookingSummaryDto;u.set("centreId",o.get("centreId")),u.set("fromBookingDate",o.get("fromDate")),u.set("toBookingDate",o.get("toDate"));var g=s.GetByCriteria(u);g.done(function(t){return e.GetByCriteriaCompleted(t)})},t.prototype.ShowBusVisitDetails=function(e,t){var o=new a.Models.ReportDto;o.set("fromDate",t.get("fromBookingDate")),o.set("toDate",t.get("toBookingDate")),o.set("busId",e),this.app.reqres.setHandler("ReportFilterSetting",function(){return o},this),location.href="#busMilageReport"},t.prototype.GetByCriteria=function(e){var t=this;""!=e.get("fromBookingDate").trim()&&e.set("fromBookingDate",i.FormatDateString(e.get("fromBookingDate"))),""!=e.get("toBookingDate").trim()&&e.set("toBookingDate",i.FormatDateString(e.get("toBookingDate")));var o=s.GetByCriteria(this.GetMinimalRequest(e));o.done(function(e){return t.GetByCriteriaCompleted(e)})},t.prototype.GetMinimalRequest=function(e){var t=new r.Models.BookingSummaryDto;return t.set("busId",e.get("busId")),t.set("fromBookingDate",e.get("fromBookingDate")),t.set("toBookingDate",e.get("toBookingDate")),t},t.prototype.GetByCriteriaCompleted=function(e){for(var t=e.bookingSummaryList,o=[],i=0;i<t.length;i++)o[i]={alkhidmatCentre:t[i].alkhidmatCentre,alkhidmatCentreId:t[i].alkhidmatCentreId,bookingAmount:t[i].bookingAmount,bookingMilage:t[i].bookingMilage,bookings:t[i].bookings,receivables:t[i].receivables,busNo:t[i].busNo,busId:t[i].busId};this.backboneCollection.reset(o)},t.prototype.Cancel=function(){window.location.href="#busCentreReport"},t}(i.Controller);t.BusCentreReportCtrl=u});