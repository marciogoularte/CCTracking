var __extends=this.__extends||function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);n.prototype=t.prototype,e.prototype=new n};define(["require","exports","../../App","../../Helper","./NearestCentreSetupView","../../Dtos/NearestCentreDto","../../DAL/NearestCentreSetup","marionette","jquery","knockout","text!./NearestCentreSetupTmpl.html"],function(e,t,n,i,o,r,s){var a=e("underscore"),l=e("knockout"),d=e("knockback"),c=function(e){function t(){e.call(this),this.app=n.Application.getInstance(),this.backboneModel=new r.Models.NearestCentreDto,this.nearestCentreSetupViewModel=new o.NearestCentreSetupViewModel(this.backboneModel,this),this.nearestCentreSetupView=new o.NearestCentreSetupView({viewModel:this.nearestCentreSetupViewModel}),this.compositeModel=new Backbone.Model}return __extends(t,e),t.prototype.Show=function(){var e=this,t=window.location.href;if(t.indexOf("id=")>-1){var n=t.substring(t.indexOf("id=")+3,t.length),i=s.GetById(n);i.done(function(t){return e.GetByIdCompleted(t)})}else this.Load()},t.prototype.Load=function(){var e=this,t=JSON.parse(localStorage.getItem("lookupResponse")),n=this.backboneModel;this.nearestCentreSetupViewModel.bbModel=n,this.nearestCentreSetupViewModel.model=d.viewModel(n),n.set("alkhidmatCentreList",t.alkhidmatCentre),n.set("alkhidmatCentreSelected",""),n.set("nearestCentreSelected",""),n.set("nearestLevel",""),n.set("isActive","1"),this.nearestCentreSetupViewModel=new o.NearestCentreSetupViewModel(n,this),this.nearestCentreSetupView=new o.NearestCentreSetupView({viewModel:this.nearestCentreSetupViewModel}),this.nearestCentreSetupView.on("SaveNearestCentreSetup",function(){return e.Save(e.nearestCentreSetupViewModel.bbModel)}),this.nearestCentreSetupView.on("CancelForm",function(){return e.Cancel()}),this.app.MainRegion.show(this.nearestCentreSetupView)},t.prototype.GetAll=function(){var e=this,t=s.GetAll();t.done(function(t){return e.GetAllCompleted(t)})},t.prototype.GetByCriteria=function(e,t){var n=(this.collection,a.filter(t.models,function(t){return t.get("centreId")==e}));this.collection.reset(n)},t.prototype.GetByIdCompleted=function(e){var t=this;this.backboneModel=new Backbone.Model(e.nearestCentreModel);var n=this.backboneModel;this.UIBinding(n),this.nearestCentreSetupView=new o.NearestCentreSetupView({viewModel:this.nearestCentreSetupViewModel}),this.nearestCentreSetupView.on("SaveNearestCentreSetup",function(){return t.Save(t.nearestCentreSetupViewModel.bbModel)}),this.nearestCentreSetupView.on("CancelForm",function(){return t.Cancel()}),this.app.MainRegion.show(this.nearestCentreSetupView)},t.prototype.GetAllCompleted=function(e){var t=this,n=JSON.parse(localStorage.getItem("lookupResponse"));this.compositeModel.set("alkhidmatCentreList",n.alkhidmatCentre),this.compositeModel.set("alkhidmatCentreSelected",""),this.collection=new Backbone.Collection(e.nearestCentreList),this.collectionView=new o.NearestCentreSetupCollectionView({collection:this.collection,model:this.compositeModel}),this.collectionView.on("itemview:ShowDetail",function(e){return t.GetByIdCompleted(e.model)}),this.collectionView.on("Event:SearchNearestCentre",function(e){return t.GetByCriteria(e,t.allCollection)}),this.allCollection=new Backbone.Collection(e.nearestCentreList),this.app.MainRegion.show(this.collectionView);var i=this.collectionView.$el,r=d.viewModel(this.compositeModel),s=i.find("#ddlCentre")[0];l.cleanNode(s),l.applyBindings(r,s)},t.prototype.Save=function(e){var t=this,n=this.app.request("AppGlobalSetting");e.set("modifiedBy",n.get("Id")),e.set("centreId",e.get("alkhidmatCentreSelected").id),e.set("nearestCentreId",e.get("nearestCentreSelected").id),e.set("isActive","1"==e.get("isActive")?!0:!1);var i=s.Save(this.GetMinimalRequest(e));i.done(function(e){return t.SaveCompleted(e)})},t.prototype.GetMinimalRequest=function(e){var t=new r.Models.NearestCentreDto;return t.set("id",e.get("id")),t.set("centreId",e.get("centreId")),t.set("nearestCentreId",e.get("nearestCentreId")),t.set("isActive",e.get("isActive")),t.set("createdBy",e.get("createdBy")),t.set("createdDate",e.get("createdDate")),t.set("modifiedBy",e.get("modifiedBy")),t.set("modifiedDate",e.get("modifiedDate")),t},t.prototype.SaveCompleted=function(e){var t=new Backbone.Model(e);void 0!=t.get("errorMessage")&&""!=t.get("errorMessage").trim()?i.ShowModalPopup("danger","Nearest Centre Setup","Due to some technical reason Nearest Centre Setup have not been saved successfully!<br> Pelase try later"):-1==e.id?i.ShowModalPopup("danger","Nearest Centre Setup","Current association already exists!<br> Pelase use a different combination"):(i.ShowModalPopup("success","Nearest Centre Setup","Record has been saved successfully with ID : "+e.id),this.Cancel())},t.prototype.Cancel=function(){window.location.href="#viewNearestCentreSetup"},t.prototype.UIBinding=function(e){var t=JSON.parse(localStorage.getItem("lookupResponse"));e.set("alkhidmatCentreList",t.alkhidmatCentre);var n=a.filter(t.alkhidmatCentre,function(t){return t.id==e.get("centreId")});e.set("alkhidmatCentreSelected",n[0]);var i=a.filter(t.alkhidmatCentre,function(t){return t.id==e.get("nearestCentreId")});e.set("nearestCentreSelected",i[0]),e.set("isActive",e.get("isActive")?"1":"0"),this.nearestCentreSetupViewModel.bbModel=e,this.nearestCentreSetupViewModel.model=d.viewModel(e),l.cleanNode($(this.nearestCentreSetupView.el)[0]),l.applyBindings(this.nearestCentreSetupViewModel,this.nearestCentreSetupView.el)},t}(i.Controller);t.NearestCentreSetupCtrl=c});