var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);i.prototype=t.prototype,e.prototype=new i};define(["require","exports","../App","../Helper","./PaymentView","CCTracking.WebClient/Dtos/BusVisitDto","../DAL/Payment","marionette","jquery","knockout","text!./PaymentTmpl.html"],function(e,t,i,o,n,s,a){var r,l=e("underscore"),d=(e("knockout"),e("knockback"),function(e){function t(){var t=this;r=i.Application.getInstance(),e.call(this),this.backboneCollection=new s.Models.BusVisitCollection,this.backboneCollection=this.busVisitCollection,this.busVisitCollectionView=new n.BusVisitCollectionView({collection:this.backboneCollection}),this.busVisitCollectionView.on("itemview:BusVisitRemoveItem",function(e,i,o,n){return t.RemoveBusVisitItem(i,o,n)}),this.busVisitCollectionView.on("itemview:UpdateBusVisitItem",function(e,i){t.UpdateBusVisitItem(i);var o=t.paymentView.viewModel.busList(),n=l.filter(o,function(e){return e.id==i.get("busId")});t.paymentView.viewModel.busSelected(n[0])}),this.idCounter=1}return __extends(t,e),t.prototype.EditPayment=function(e){var t=this,i=a.GetBusAvialability(e);i.done(function(i){t.FillBusAvailability(i,e)})},t.prototype.FillBusAvailability=function(e,t){var i=this,o=e.busAvailabilityList;if(t>0){var n=a.GetById(t);n.done(function(e){return i.GetByIdCompleted(e,o)})}else this.LoadCompleted(o)},t.prototype.GetByIdCompleted=function(e,t){var i=this,s=new Backbone.Model(e.paymentModel);s.set("bookingId",s.get("bookingId")),this.layout=r.AppLayout,this.paymentView=new n.PaymentView(t,s),this.paymentView.on("BusVisitAddItem",function(e,t,o,n,s){return i.AddBusVisitItem(e,t,o,n,s)}),this.paymentView.on("BusVisitUpdateItem",function(e,t,o,n,s,a){return i.ModifyBusVisitItem(e,t,o,n,s,a)}),this.paymentView.on("PaymentSave",function(e){return i.Save(e)});var a=l.map(s.get("busVisits"),function(e){return e.fuelAmount=o.FormatMoney(e.fuelAmount),e});this.backboneCollection=new Backbone.Collection(a),this.busVisitCollectionView=new n.BusVisitCollectionView({collection:this.backboneCollection}),this.busVisitCollectionView.on("itemview:BusVisitRemoveItem",function(e,t,o,n){return i.RemoveBusVisitItem(t,o,n)}),this.busVisitCollectionView.on("itemview:UpdateBusVisitItem",function(e,t){i.UpdateBusVisitItem(t);var o=i.paymentView.viewModel.busList(),n=l.filter(o,function(e){return e.id==t.get("busId")});i.paymentView.viewModel.busSelected(n[0])}),r.MainRegion.show(this.paymentView),r.SubRegion.reset(),r.SubRegion.show(this.busVisitCollectionView)},t.prototype.InitalizeKoBinding=function(e){e.set("amount",""),e.set("busChangeReason",""),e.set("receiptNo",""),e.set("easyPaisaTranNo",""),e.set("extraAmountCharge",""),e.set("extraAmountReason",""),e.set("extraAmountReceipt","")},t.prototype.LoadCompleted=function(e){var t=this;this.layout=r.AppLayout,this.paymentView=new n.PaymentView(e),this.paymentView.on("BusVisitAddItem",function(e,i,o,n,s){return t.AddBusVisitItem(e,i,o,n,s)}),this.paymentView.on("BusVisitUpdateItem",function(e,i,o,n,s,a){return t.ModifyBusVisitItem(e,i,o,n,s,a)}),this.paymentView.on("PaymentSave",function(e){return t.Save(e)}),r.MainRegion.show(this.paymentView),r.SubRegion.reset(),r.SubRegion.show(this.busVisitCollectionView)},t.prototype.AddBusVisitItem=function(e,t,i,n,a){if(void 0==n||n.length<=0)return void o.ShowModalPopup("danger","Bus Info","Please enter valid  vehicle no.!");if(""==a||void 0==a||0===a)return void o.ShowModalPopup("danger","Bus Info","Please enter valid amount!");var r=this.idCounter++,d=this.backboneCollection.findWhere({busId:n.id}),u=this.backboneCollection.findWhere({driverId:i.id});if(void 0==d&&void 0==u){this.backboneCollection.push(new s.Models.BusVisitDto({busVisitId:r,centreId:t.id,centreDesc:t.description,busId:n.id,busDesc:n.description,driverId:i.id,driverDesc:i.description,visitTypeId:"2",bookingId:e,fuelAmount:a.replace(",","")})),this.busVisitCollectionView.collection=this.backboneCollection;var c=l.reduce(this.backboneCollection.models,function(e,t){return e+parseFloat(t.get("fuelAmount").replace(",",""))},0);this.paymentView.viewModel.amount(o.FormatMoney(c))}else o.ShowModalPopup("danger","Bus Info","Entry already exists!")},t.prototype.ModifyBusVisitItem=function(e,t,i,n,s,a){if(void 0==n||n.length<=0)return void o.ShowModalPopup("danger","Bus Info","Please enter valid  vehicle no.!");if(""==s||void 0==s||0===s)return void o.ShowModalPopup("danger","Bus Info","Please enter valid amount!");if(""==a||void 0==a)return void o.ShowModalPopup("danger","Bus Info","Please enter reason for bus change!");var r=(this.idCounter++,this.backboneCollection.findWhere({busId:n.id})),d=this.backboneCollection.findWhere({driverId:i.id});if(void 0!=r&&void 0!=d){var u=l.map(this.backboneCollection.models,function(o){return o.get("busId")==n.id&&o.get("driverId")==i.id&&(o.set("centreId",t.id),o.set("centreDesc",t.description),o.set("busId",n.id),o.set("busDesc",n.description),o.set("driverId",i.id),o.set("driverDesc",i.description),o.set("visitTypeId","2"),o.set("bookingId",e),o.set("fuelAmount",s.replace(",","")),o.set("busChangeReason",a)),o});this.backboneCollection.reset(u),this.busVisitCollectionView.collection=this.backboneCollection;var c=l.reduce(this.backboneCollection.models,function(e,t){return e+parseFloat(t.get("fuelAmount").replace(",",""))},0);this.paymentView.viewModel.amount(o.FormatMoney(c))}else o.ShowModalPopup("danger","Bus Info","You cannot modify centre & bus info");var p=this.paymentView.$el;p.find("#ddlCentre").prop("disabled",!1),p.find("#ddlBusDetails").prop("disabled",!1),p.find("#lnkAdd").show(),p.find("#lnkUpdate").hide(),this.paymentView.viewModel.busChangeReason("")},t.prototype.RemoveBusVisitItem=function(e,t,i){this.backboneCollection.remove(this.backboneCollection.findWhere({busId:e,centreId:t,driverId:i}));var n=l.reduce(this.backboneCollection.models,function(e,t){return e+parseFloat(t.get("fuelAmount").replace(",",""))},0);this.paymentView.viewModel.amount(o.FormatMoney(n))},t.prototype.UpdateBusVisitItem=function(e){var t=this.paymentView.viewModel.alkhidmatCentreList(),i=this.paymentView.viewModel.driverList(),o=(this.paymentView.viewModel.busList(),l.filter(t,function(t){return t.id==e.get("centreId")})),n=l.filter(i,function(t){return t.id==e.get("driverId")});this.paymentView.viewModel.fuelAmount(e.get("fuelAmount")),this.paymentView.viewModel.busChangeReason(e.get("busChangeReason")),this.paymentView.viewModel.driverSelected(n[0]),this.paymentView.viewModel.alkhidmatCentreSelected(o[0]);var s=this.paymentView.$el;s.find("#ddlCentre").prop("disabled",!0),s.find("#ddlBusDetails").prop("disabled",!0),s.find("#lnkAdd").hide(),s.find("#lnkUpdate").show()},t.prototype.Save=function(e){var t=this;if(this.backboneCollection.length<1)return void o.ShowModalPopup("danger","Bus Details","Please add bus details");if(e.get("isReferralBooking")&&e.get("isReferralBookingPaid")&&(void 0==e.get("referralPaymentDate")||""==e.get("referralPaymentDate")))return void o.ShowModalPopup("danger","Bus Details","Please enter Referral Booking date.");var i=r.request("AppGlobalSetting");e.set("modifiedBy",i.get("Id")),e.set("amount",e.get("amount").replace(",",""));var n=this.RemoveAmountFormatting(this.backboneCollection.toJSON());e.set("busVisits",n);var s=a.Save(e);s.done(function(e){return t.SaveCompleted(e)})},t.prototype.SaveCompleted=function(e){var t=new Backbone.Model(e);void 0!=t.get("errorMessage")&&""!=t.get("errorMessage").trim()?(console.log(t.get("errorMessage")),o.ShowModalPopup("danger","Payment","Due to some technical reason payment have not been saved successfully!<br> Pelase try later")):(o.ShowModalPopup("success","Payment","Record has been saved successfully with Payment ID : "+e.id),location.href="#viewBooking")},t.prototype.RemoveAmountFormatting=function(e){var t=null;return void 0!=e&&(t=l.map(e,function(e){return e.fuelAmount=e.fuelAmount.replace(",",""),e})),t},t.prototype.GetMinimalRequest=function(){for(var e=[],t=0;t<this.backboneCollection.length;t++){var i={centreId:this.backboneCollection.models[t].get("centreId"),busId:this.backboneCollection.models[t].get("busId"),driverId:this.backboneCollection.models[t].get("driverId"),visitTypeId:this.backboneCollection.models[t].get("visitTypeId"),bookingId:this.backboneCollection.models[t].get("bookingId"),fuelAmount:this.backboneCollection.models[t].get("fuelAmount")};e.push(i)}return e},t}(o.Controller));t.PaymentCtrl=d});