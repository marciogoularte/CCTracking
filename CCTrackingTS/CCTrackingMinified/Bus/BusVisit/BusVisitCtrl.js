var __extends=this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);i.prototype=e.prototype,t.prototype=new i};define(["require","exports","../../App","../../Helper","./BusVisitView","../../DAL/BusVisit","marionette","jquery","knockout"],function(t,e,i,o,n,s){var r=t("underscore"),a=t("knockout"),c=t("knockback"),u=function(t){function e(){t.call(this),this.app=i.Application.getInstance(),this.currentLayout=new n.SearchBusVisitLayoutView,this.searchView=new n.BusVisitSearchItemView,this.compositeModel=new Backbone.Model}return __extends(e,t),e.prototype.Load=function(){var t=this;this.view=new n.BusVisitView,this.view.on("Event:SaveForm",function(e){return t.Save(e)}),this.view.on("Event:CancelForm",function(){return t.Cancel()}),this.app.MainRegion.show(this.view)},e.prototype.EditForm=function(t){var e=this,i=s.GetById(t);i.done(function(t){return e.GetByIdCompleted(t)})},e.prototype.SimpleLoad=function(){var t=this,e=JSON.parse(localStorage.getItem("lookupResponse"));this.compositeModel.set("busList",e.bus),this.compositeModel.set("busSelected",""),this.app.MainRegion.show(this.currentLayout),this.searchView.model=this.compositeModel,this.searchView.on("Event:SearchVisit",function(e){t.SearchVisit(e)}),this.currentLayout.SearchRegion.show(this.searchView);var i=c.viewModel(this.compositeModel),o=$("#ddlBuses")[0];a.cleanNode(o),a.applyBindings(i,o)},e.prototype.SearchVisit=function(t){var e=this,i=s.GetAll(t);i.done(function(t){return e.GetAllCompleted(t)})},e.prototype.GetAllCompleted=function(t){var e=this,i=r.map(t.busVisitList,function(t){return t.visitDate=o.FormatDateString(t.visitDate),void 0!=t.returnDate&&(t.returnDate=o.FormatDateString(t.returnDate)),t});this.collection=new Backbone.Collection(i),this.collectionView=new n.BusVisitCollectionView({collection:this.collection}),this.collectionView.on("itemview:Event:EditForm",function(t,i){return e.EditForm(i)}),this.currentLayout.ContentRegion.show(this.collectionView)},e.prototype.GetByIdCompleted=function(t){var e=this,i=new Backbone.Model(t.busVisitModel);null!=i.get("visitDate")&&""!=i.get("visitDate").trim()&&i.set("visitDate",o.FormatDateString(i.get("visitDate"))),null!=i.get("returnDate")&&""!=i.get("returnDate").trim()&&i.set("returnDate",o.FormatDateString(i.get("returnDate"))),this.view=new n.BusVisitView(i),this.view.on("Event:SaveForm",function(t){return e.Save(t)}),this.view.on("Event:CancelForm",function(){return e.Cancel()}),this.app.MainRegion.show(this.view)},e.prototype.Save=function(t){var e=this,i=this.app.request("AppGlobalSetting");t.set("modifiedBy",i.get("Id")),t.set("isBookingCompleted","1"==t.get("isBookingCompleted")?!0:!1);var o=s.Save(t);o.done(function(t){return e.SaveCompleted(t)})},e.prototype.Cancel=function(){window.location.href="#viewBusVisit"},e.prototype.SaveCompleted=function(t){void 0==t?o.ShowModalPopup("danger","Bus Visit","Bus visit have not been saved successfully!"):(o.ShowModalPopup("success","Bus Visit","Record has been saved successfully with Bus Visit ID : "+t.id),this.Cancel())},e}(o.Controller);e.BusVisitCtrl=u});