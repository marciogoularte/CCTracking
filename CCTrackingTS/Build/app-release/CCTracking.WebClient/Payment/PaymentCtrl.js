var __extends=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r};define(["require","exports","../App","../Helper","./PaymentView","CCTracking.WebClient/Dtos/BusVisitDto","../DAL/Payment","marionette","jquery","knockout","text!./PaymentTmpl.html"],function(e,t,n,r,i,s,o){var u=e("underscore"),a=e("knockout"),f=e("knockback"),l,c=function(e){function t(){var t=this;l=n.Application.getInstance(),e.call(this),this.backboneCollection=new s.Models.BusVisitCollection,this.backboneCollection=this.busVisitCollection,this.busVisitCollectionView=new i.BusVisitCollectionView({collection:this.backboneCollection}),this.busVisitCollectionView.on("itemview:BusVisitRemoveItem",function(e,n,r,i){return t.RemoveBusVisitItem(n,r,i)}),this.busVisitCollectionView.on("itemview:UpdateBusVisitItem",function(e,n){t.UpdateBusVisitItem(n);var r=t.paymentView.viewModel.busList(),i=u.filter(r,function(e){return e.id==n.get("busId")});t.paymentView.viewModel.busSelected(i[0])}),this.idCounter=1}return __extends(t,e),t.prototype.EditPayment=function(e){var t=this,n=o.GetBusAvialability(e);n.done(function(n){t.FillBusAvailability(n,e)})},t.prototype.FillBusAvailability=function(e,t){var n=this,r=e.busAvailabilityList;if(t>0){var i=o.GetById(t);i.done(function(e){return n.GetByIdCompleted(e,r)})}else this.LoadCompleted(r)},t.prototype.GetByIdCompleted=function(e,t){var n=this,s=new Backbone.Model(e.paymentModel);s.set("bookingId",s.get("bookingId")),this.layout=l.AppLayout,this.paymentView=new i.PaymentView(t,s),this.paymentView.on("BusVisitAddItem",function(e,t,r,i,s){return n.AddBusVisitItem(e,t,r,i,s)}),this.paymentView.on("BusVisitUpdateItem",function(e,t,r,i,s,o){return n.ModifyBusVisitItem(e,t,r,i,s,o)}),this.paymentView.on("PaymentSave",function(e){return n.Save(e)});var o=u.map(s.get("busVisits"),function(e){return e.fuelAmount=r.FormatMoney(e.fuelAmount),e});this.backboneCollection=new Backbone.Collection(o),this.busVisitCollectionView=new i.BusVisitCollectionView({collection:this.backboneCollection}),this.busVisitCollectionView.on("itemview:BusVisitRemoveItem",function(e,t,r,i){return n.RemoveBusVisitItem(t,r,i)}),this.busVisitCollectionView.on("itemview:UpdateBusVisitItem",function(e,t){n.UpdateBusVisitItem(t);var r=n.paymentView.viewModel.busList(),i=u.filter(r,function(e){return e.id==t.get("busId")});n.paymentView.viewModel.busSelected(i[0])}),l.MainRegion.show(this.paymentView),l.SubRegion.reset(),l.SubRegion.show(this.busVisitCollectionView)},t.prototype.InitalizeKoBinding=function(e){e.set("amount",""),e.set("busChangeReason",""),e.set("receiptNo",""),e.set("easyPaisaTranNo",""),e.set("extraAmountCharge",""),e.set("extraAmountReason",""),e.set("extraAmountReceipt","")},t.prototype.LoadCompleted=function(e){var t=this;this.layout=l.AppLayout,this.paymentView=new i.PaymentView(e),this.paymentView.on("BusVisitAddItem",function(e,n,r,i,s){return t.AddBusVisitItem(e,n,r,i,s)}),this.paymentView.on("BusVisitUpdateItem",function(e,n,r,i,s,o){return t.ModifyBusVisitItem(e,n,r,i,s,o)}),this.paymentView.on("PaymentSave",function(e){return t.Save(e)}),l.MainRegion.show(this.paymentView),l.SubRegion.reset(),l.SubRegion.show(this.busVisitCollectionView)},t.prototype.AddBusVisitItem=function(e,t,n,i,o){if(i==undefined||i.length<=0){r.ShowModalPopup("danger","Bus Info","Please enter valid  vehicle no.!");return}if(o==""||o==undefined||o===0){r.ShowModalPopup("danger","Bus Info","Please enter valid amount!");return}var a=this.idCounter++,f=this.backboneCollection.findWhere({busId:i.id}),l=this.backboneCollection.findWhere({driverId:n.id});if(f==undefined&&l==undefined){this.backboneCollection.push(new s.Models.BusVisitDto({busVisitId:a,centreId:t.id,centreDesc:t.description,busId:i.id,busDesc:i.description,driverId:n.id,driverDesc:n.description,visitTypeId:"2",bookingId:e,fuelAmount:o.replace(",","")})),this.busVisitCollectionView.collection=this.backboneCollection;var c=u.reduce(this.backboneCollection.models,function(e,t){return e+parseFloat(t.get("fuelAmount").replace(",",""))},0);this.paymentView.viewModel.amount(r.FormatMoney(c))}else r.ShowModalPopup("danger","Bus Info","Entry already exists!")},t.prototype.ModifyBusVisitItem=function(e,t,n,i,s,o){if(i==undefined||i.length<=0){r.ShowModalPopup("danger","Bus Info","Please enter valid  vehicle no.!");return}if(s==""||s==undefined||s===0){r.ShowModalPopup("danger","Bus Info","Please enter valid amount!");return}if(o==""||o==undefined){r.ShowModalPopup("danger","Bus Info","Please enter reason for bus change!");return}var a=this.idCounter++,f=this.backboneCollection.findWhere({busId:i.id}),l=this.backboneCollection.findWhere({driverId:n.id});if(f!=undefined&&l!=undefined){var c=u.map(this.backboneCollection.models,function(r){return r.get("busId")==i.id&&r.get("driverId")==n.id&&(r.set("centreId",t.id),r.set("centreDesc",t.description),r.set("busId",i.id),r.set("busDesc",i.description),r.set("driverId",n.id),r.set("driverDesc",n.description),r.set("visitTypeId","2"),r.set("bookingId",e),r.set("fuelAmount",s.replace(",","")),r.set("busChangeReason",o)),r});this.backboneCollection.reset(c),this.busVisitCollectionView.collection=this.backboneCollection;var h=u.reduce(this.backboneCollection.models,function(e,t){return e+parseFloat(t.get("fuelAmount").replace(",",""))},0);this.paymentView.viewModel.amount(r.FormatMoney(h))}else r.ShowModalPopup("danger","Bus Info","You cannot modify centre & bus info");var p=this.paymentView.$el;p.find("#ddlCentre").prop("disabled",!1),p.find("#ddlBusDetails").prop("disabled",!1),p.find("#lnkAdd").show(),p.find("#lnkUpdate").hide(),this.paymentView.viewModel.busChangeReason("")},t.prototype.RemoveBusVisitItem=function(e,t,n){this.backboneCollection.remove(this.backboneCollection.findWhere({busId:e,centreId:t,driverId:n}));var i=u.reduce(this.backboneCollection.models,function(e,t){return e+parseFloat(t.get("fuelAmount").replace(",",""))},0);this.paymentView.viewModel.amount(r.FormatMoney(i))},t.prototype.UpdateBusVisitItem=function(e){var t=this.paymentView.viewModel.alkhidmatCentreList(),n=this.paymentView.viewModel.driverList(),r=this.paymentView.viewModel.busList(),i=u.filter(t,function(t){return t.id==e.get("centreId")}),s=u.filter(n,function(t){return t.id==e.get("driverId")});this.paymentView.viewModel.fuelAmount(e.get("fuelAmount")),this.paymentView.viewModel.busChangeReason(e.get("busChangeReason")),this.paymentView.viewModel.driverSelected(s[0]),this.paymentView.viewModel.alkhidmatCentreSelected(i[0]);var o=this.paymentView.$el;o.find("#ddlCentre").prop("disabled",!0),o.find("#ddlBusDetails").prop("disabled",!0),o.find("#lnkAdd").hide(),o.find("#lnkUpdate").show()},t.prototype.Save=function(e){var t=this;if(this.backboneCollection.length<1){r.ShowModalPopup("danger","Bus Details","Please add bus details");return}if(e.get("isReferralBooking")&&e.get("isReferralBookingPaid")&&(e.get("referralPaymentDate")==undefined||e.get("referralPaymentDate")=="")){r.ShowModalPopup("danger","Bus Details","Please enter Referral Booking date.");return}var n=l.request("AppGlobalSetting");e.set("modifiedBy",n.get("Id")),e.set("amount",e.get("amount").replace(",",""));var i=this.RemoveAmountFormatting(this.backboneCollection.toJSON());e.set("busVisits",i);var s=o.Save(e);s.done(function(e){return t.SaveCompleted(e)})},t.prototype.SaveCompleted=function(e){var t=new Backbone.Model(e);t.get("errorMessage")!=undefined&&t.get("errorMessage").trim()!=""?(console.log(t.get("errorMessage")),r.ShowModalPopup("danger","Payment","Due to some technical reason payment have not been saved successfully!<br> Pelase try later")):(r.ShowModalPopup("success","Payment","Record has been saved successfully with Payment ID : "+e.id),location.href="#viewBooking")},t.prototype.RemoveAmountFormatting=function(e){var t=null;return e!=undefined&&(t=u.map(e,function(e){return e.fuelAmount=e.fuelAmount.replace(",",""),e})),t},t.prototype.GetMinimalRequest=function(){var e=[];for(var t=0;t<this.backboneCollection.length;t++){var n={centreId:this.backboneCollection.models[t].get("centreId"),busId:this.backboneCollection.models[t].get("busId"),driverId:this.backboneCollection.models[t].get("driverId"),visitTypeId:this.backboneCollection.models[t].get("visitTypeId"),bookingId:this.backboneCollection.models[t].get("bookingId"),fuelAmount:this.backboneCollection.models[t].get("fuelAmount")};e.push(n)}return e},t}(r.Controller);t.PaymentCtrl=c});