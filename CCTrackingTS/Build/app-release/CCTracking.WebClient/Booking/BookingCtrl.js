var __extends=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r};define(["require","exports","../App","../Helper","./BookingView","CCTracking.WebClient/Dtos/BookingDto","../DAL/Booking","marionette","jquery","knockout","selectize","text!./BookingTmpl.html"],function(e,t,n,r,i,s,o){var u=e("underscore"),a=e("knockout"),f=e("selectize"),l,c=function(t){function a(){l=n.Application.getInstance(),t.call(this)}return __extends(a,t),a.prototype.Show=function(){this.LoadCompleted(JSON.parse(localStorage.getItem("lookupResponse")))},a.prototype.EditBooking=function(e){var t=this,n=o.GetById(e);n.done(function(e){return t.GetByIdCompleted(e)})},a.prototype.GetByIdCompleted=function(e){var t=this,n=JSON.parse(localStorage.getItem("lookupResponse")),s=new Backbone.Model(e.bookingModel);s.set("causeOfDeathList",n.causeOfDeath),s.set("landmarkList",n.landmark),s.set("busPointList",n.landmark),s.set("unionCouncilList",n.unionCouncil),s.set("townList",n.town),s.set("graveyardList",n.graveyard),s.set("busDetailsList",n.bus),s.set("pickupTimeSlotList",n.timeSlot),s.set("returnTimeSlotList",n.timeSlot),s.set("prayersList",n.prayers),s.set("prayersList",n.prayers),s.set("alkhidmatCentreList",n.alkhidmatCentre);var o=u.filter(n.causeOfDeath,function(e){return e.id==s.get("causeOfDeath")}),a=u.filter(n.landmark,function(e){return e.id==s.get("landmarkId")}),f=u.filter(n.landmark,function(e){return e.id==s.get("busPoint")}),c=u.filter(n.unionCouncil,function(e){return e.id==s.get("unionCouncilId")}),h=u.filter(n.town,function(e){return e.id==s.get("townId")}),p=u.filter(n.graveyard,function(e){return e.id==s.get("graveyardId")}),d=u.filter(n.bus,function(e){return e.id==s.get("busDetailId")}),v=u.filter(n.timeSlot,function(e){return e.id==s.get("pickupTime")}),m=u.filter(n.timeSlot,function(e){return e.id==s.get("returnTime")}),g=u.filter(n.prayers,function(e){return e.id==s.get("namazEJanazaHeldIn")}),y=u.filter(n.alkhidmatCentre,function(e){return e.id==s.get("alkhidmatCentreId")});s.set("causeOfDeathSelected",o[0]),s.set("busPointSelected",f[0]),s.set("unionCouncilIdSelected",c[0]),s.set("townIdSelected",h[0]),s.set("graveyardIdSelected",p[0]),s.set("busDetailIdSelected",d[0]),s.set("deseasedGender",s.get("deseasedGender").toString()),s.set("alkhidmatCentreSelected",y[0]),s.set("pickupTimeSlotSelected",v[0]),s.set("returnTimeSlotSelected",m[0]),s.set("prayersSelected",g[0]),s.set("isReferralBooking",s.get("isReferralBooking")?"1":"0"),s.set("pickupDate",r.FormatDateString(s.get("pickupDate"))),this.bookingViewModel=new i.BookingViewModel(s,this),this.bookingView=new i.BookingView({viewModel:this.bookingViewModel}),this.bookingView.on("SaveBooking",function(){return t.Save(t.bookingViewModel.bbModel)}),this.layout=l.AppLayout,l.MainRegion.show(this.bookingView),f[0]!=undefined&&this.bookingView.$el.find("#txtBusPoint").append(f[0].description)},a.prototype.LoadCompleted=function(e){var t=this,n=new s.Models.BookingResponse;n.set("contactName",""),n.set("contactMobile",""),n.set("contactNic",""),n.set("deseasedName",""),n.set("deseasedAge",""),n.set("deseasedGender",""),n.set("causeOfDeathList",e.causeOfDeath),n.set("causeOfDeathSelected",""),n.set("address",""),n.set("landmarkIdSelected",""),n.set("landmarkList",e.landmark),n.set("busPointList",e.landmark),n.set("busPointSelected",""),n.set("alkhidmatCentreList",e.alkhidmatCentre),n.set("alkhidmatCentreSelected",""),n.set("unionCouncilList",e.unionCouncil),n.set("unionCouncilIdSelected",""),n.set("townList",e.town),n.set("townIdSelected",""),n.set("pickupDate",""),n.set("pickupTime",""),n.set("returnTime",""),n.set("graveyardList",e.graveyard),n.set("graveyardIdSelected",""),n.set("pickupTimeSlotList",e.timeSlot),n.set("pickupTimeSlotSelected",""),n.set("returnTimeSlotList",e.timeSlot),n.set("returnTimeSlotSelected",""),n.set("prayersList",e.prayers),n.set("prayersSelected",""),n.set("namazEJanazaHeldIn",""),n.set("namazEJanazaLocation",""),n.set("masjidName",""),n.set("otherDetail",""),n.set("isReferralBooking",""),n.set("referralName",""),n.set("referralDetail",""),this.bookingViewModel=new i.BookingViewModel(n,this),this.bookingView=new i.BookingView({viewModel:this.bookingViewModel}),this.bookingView.on("SaveBooking",function(){return t.Save(t.bookingViewModel.bbModel)}),this.layout=l.AppLayout,l.MainRegion.show(this.bookingView)},a.prototype.GetAll=function(e){var t=this;typeof e=="undefined"&&(e=1),e==undefined&&(e=1);var n=o.GetAll(e);n.done(function(e){return t.GetAllCompleted(e)})},a.prototype.GetAllCompleted=function(t){var o=this;l=n.Application.getInstance();var a=u.map(t.bookingList,function(e){return e.pickupDate!="0001-01-01T00:00:00"?e.pickupDate=r.FormatDateString(e.pickupDate):e.pickupDate="",e}),f=new s.Models.BookingResponseCollection(a),c=new i.BookingCollectionView({collection:f});c.listenTo(c,"itemview:ExportToPdf",function(e,t){r.PrintReceipt(t)}),c.listenTo(c,"itemview:Event:EditBooking",function(e,t){o.EditBooking(t)}),c.listenTo(c,"itemview:Event:EditPayment",function(t,n){e(["./../Payment/PaymentCtrl"],function(e){(new e.PaymentCtrl).EditPayment(n)})}),c.listenTo(c,"itemview:Event:EditRefund",function(t,n){e(["./../RefundBooking/RefundBookingCtrl"],function(e){(new e.RefundBookingCtrl).EditRefund(n)})}),c.listenTo(c,"itemview:Event:EditExtraCharge",function(t,n){e(["./../ExtraCharge/ExtraChargeCtrl"],function(e){(new e.ExtraChargeCtrl).EditExtraCharge(n)})}),l.MainRegion.show(c)},a.prototype.Save=function(e){var t=this,n=l.request("AppGlobalSetting");e.set("modifiedBy",n.get("Id")),e.set("causeOfDeath",e.get("causeOfDeathSelected").id),e.set("busPoint",e.get("busPointSelected").id),e.set("unionCouncilId",e.get("unionCouncilIdSelected").id),e.set("townId",e.get("townIdSelected").id),e.set("graveyardId",e.get("graveyardIdSelected").id),e.set("pickupTime",e.get("pickupTimeSlotSelected").id),e.set("returnTime",e.get("returnTimeSlotSelected").id),e.set("namazEJanazaHeldIn",e.get("prayersSelected").id),e.set("alkhidmatCentreId",e.get("alkhidmatCentreSelected").id);if(e.get("isReferralBooking")=="1"&&e.get("referralName").trim().length==0){r.ShowModalPopup("danger","Booking","Please enter referral name.");return}e.set("isReferralBooking",e.get("isReferralBooking")=="1"?!0:!1);var i=o.Save(this.GetMinimalRequest(e));i.done(function(e){t.SaveCompleted(e)})},a.prototype.GetMinimalRequest=function(e){var t=new s.Models.BookingRequest;return t.set("alkhidmatCentreId",e.get("alkhidmatCentreId")),t.set("address",e.get("address")),t.set("busPoint",e.get("busPoint")),t.set("causeOfDeath",e.get("causeOfDeath")),t.set("contactMobile",e.get("contactMobile")),t.set("contactName",e.get("contactName")),t.set("contactNic",e.get("contactNic")),t.set("createdBy",e.get("createdBy")),t.set("createdDate",e.get("createdDate")),t.set("deseasedAge",e.get("deseasedAge")),t.set("deseasedGender",e.get("deseasedGender")),t.set("deseasedName",e.get("deseasedName")),t.set("graveyardId",e.get("graveyardId")),t.set("id",e.get("id")),t.set("isActive",e.get("isActive")),t.set("isReferralBooking",e.get("isReferralBooking")),t.set("landmarkId",e.get("landmarkId")),t.set("masjidName",e.get("masjidName")),t.set("modifiedBy",e.get("modifiedBy")),t.set("modifiedDate",e.get("modifiedDate")),t.set("namazEJanazaHeldIn",e.get("namazEJanazaHeldIn")),t.set("namazEJanazaLocation",e.get("namazEJanazaLocation")),t.set("operationType",e.get("operationType")),t.set("otherDetail",e.get("otherDetail")),t.set("pickupDate",e.get("pickupDate")),t.set("pickupTime",e.get("pickupTime")),t.set("referralDetail",e.get("referralDetail")),t.set("referralName",e.get("referralName")),t.set("returnTime",e.get("returnTime")),t.set("townId",e.get("townId")),t.set("unionCouncilId",e.get("unionCouncilId")),t},a.prototype.SaveCompleted=function(t){var n=new Backbone.Model(t);n.get("errorMessage")!=undefined&&n.get("errorMessage").trim()!=""?(console.log(n.get("errorMessage")),r.ShowModalPopup("danger","Booking","Due to some technical reason booking have not been saved successfully!<br> Pelase try later")):(r.ShowModalPopup("success","Booking","Record has been saved successfully with Booking ID : "+t.id),e(["./../Payment/PaymentCtrl"],function(e){(new e.PaymentCtrl).EditPayment(n.get("id"))}))},a}(r.Controller);t.BookingCtrl=c});