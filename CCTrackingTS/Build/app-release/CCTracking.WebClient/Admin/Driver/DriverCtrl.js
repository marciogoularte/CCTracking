var __extends=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r};define(["require","exports","../../App","../../Helper","./DriverView","../../Dtos/DriverDto","../../DAL/Driver","marionette","jquery","knockout","text!./DriverTmpl.html"],function(e,t,n,r,i,s,o){var u=e("underscore"),a=e("knockout"),f=e("knockback"),l=function(e){function t(){e.call(this),this.app=n.Application.getInstance(),this.backboneModel=new s.Models.DriverDto,this.driverViewModel=new i.DriverViewModel(this.backboneModel,this),this.driverView=new i.DriverView({viewModel:this.driverViewModel}),this.collection=new s.Models.DriverCollection({}),this.collectionView=new i.DriverCollectionView({collection:this.collection})}return __extends(t,e),t.prototype.Show=function(){var e=this,t=window.location.href;if(t.indexOf("id=")>-1){var n=t.substring(t.indexOf("id=")+3,t.length),r=o.GetById(n);r.done(function(t){return e.GetByIdCompleted(t)})}else this.Load()},t.prototype.Load=function(){var e=this,t=JSON.parse(localStorage.getItem("lookupResponse")),n=this.backboneModel;this.driverViewModel.bbModel=n,this.driverViewModel.model=f.viewModel(n),n.set("firstName",""),n.set("lastName",""),n.set("alkhidmatCentreList",t.alkhidmatCentre),n.set("alkhidmatCentreSelected",""),n.set("cnic",""),n.set("address",""),n.set("city",""),n.set("mobile",""),n.set("isActive",""),this.driverViewModel=new i.DriverViewModel(n,this),this.driverView=new i.DriverView({viewModel:this.driverViewModel}),this.driverView.on("SaveDriver",function(){return e.Save(e.driverViewModel.bbModel)}),this.driverView.on("CancelForm",function(){return e.Cancel()}),this.app.MainRegion.show(this.driverView)},t.prototype.GetAll=function(){var e=this,t=o.GetAll();t.done(function(t){return e.GetAllCompleted(t)})},t.prototype.GetByIdCompleted=function(e){var t=this;this.backboneModel=new Backbone.Model(e.driverModel);var n=this.backboneModel;this.UIBinding(n),this.driverView=new i.DriverView({viewModel:this.driverViewModel}),this.driverView.on("SaveDriver",function(){return t.Save(t.driverViewModel.bbModel)}),this.driverView.on("CancelForm",function(){return t.Cancel()}),this.app.MainRegion.show(this.driverView)},t.prototype.Save=function(e){var t=this,n=this.app.request("AppGlobalSetting");e.set("modifiedBy",n.get("Id")),e.set("centreId",e.get("alkhidmatCentreSelected").id),e.set("isActive",e.get("isActive")=="1"?!0:!1);var r=o.Save(this.GetMinimalRequest(e));r.done(function(e){return t.SaveCompleted(e)})},t.prototype.GetMinimalRequest=function(e){var t=new s.Models.DriverDto;return t.set("id",e.get("id")),t.set("centreId",e.get("centreId")),t.set("firstName",e.get("firstName")),t.set("lastName",e.get("lastName")),t.set("cnic",e.get("cnic")),t.set("mobile",e.get("mobile")),t.set("address",e.get("address")),t.set("city",e.get("city")),t.set("isActive",e.get("isActive")),t.set("createdBy",e.get("createdBy")),t.set("createdDate",e.get("createdDate")),t.set("modifiedBy",e.get("modifiedBy")),t.set("modifiedDate",e.get("modifiedDate")),t},t.prototype.GetAllCompleted=function(e){var t=this;this.collection.reset(e.driverList),this.collectionView=new i.DriverCollectionView({collection:this.collection}),this.collectionView.on("itemview:ShowDetail",function(e){return t.GetByIdCompleted(e.model)}),this.app.MainRegion.show(this.collectionView)},t.prototype.SaveCompleted=function(e){var t=new Backbone.Model(e);t.get("errorMessage")!=undefined&&t.get("errorMessage").trim()!=""?r.ShowModalPopup("danger","Driver","Due to some technical reason Driver have not been saved successfully!<br> Pelase try later"):(r.ShowModalPopup("success","Driver","Record has been saved successfully with Driver ID : "+e.id),this.Cancel())},t.prototype.Cancel=function(){window.location.href="#viewDriver"},t.prototype.UIBinding=function(e){var t=JSON.parse(localStorage.getItem("lookupResponse"));e.set("alkhidmatCentreList",t.alkhidmatCentre);var n=u.filter(t.alkhidmatCentre,function(t){return t.id==e.get("centreId")});e.set("alkhidmatCentreSelected",n[0]),e.set("isActive",e.get("isActive")?"1":"0"),this.driverViewModel.bbModel=e,this.driverViewModel.model=f.viewModel(e),a.cleanNode($(this.driverView.el)[0]),a.applyBindings(this.driverViewModel,this.driverView.el)},t}(r.Controller);t.DriverCtrl=l});