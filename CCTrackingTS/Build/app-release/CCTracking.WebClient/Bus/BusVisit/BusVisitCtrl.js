var __extends=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r};define(["require","exports","../../App","../../Helper","./BusVisitView","../../DAL/BusVisit","marionette","jquery","knockout"],function(e,t,n,r,i,s){var o=e("underscore"),u=e("knockout"),a=e("knockback"),f=function(e){function t(){e.call(this),this.app=n.Application.getInstance(),this.currentLayout=new i.SearchBusVisitLayoutView,this.searchView=new i.BusVisitSearchItemView,this.compositeModel=new Backbone.Model}return __extends(t,e),t.prototype.Load=function(){var e=this;this.view=new i.BusVisitView,this.view.on("Event:SaveForm",function(t){return e.Save(t)}),this.view.on("Event:CancelForm",function(){return e.Cancel()}),this.app.MainRegion.show(this.view)},t.prototype.EditForm=function(e){var t=this,n=s.GetById(e);n.done(function(e){return t.GetByIdCompleted(e)})},t.prototype.SimpleLoad=function(){var e=this,t=JSON.parse(localStorage.getItem("lookupResponse"));this.compositeModel.set("busList",t.bus),this.compositeModel.set("busSelected",""),this.app.MainRegion.show(this.currentLayout),this.searchView.model=this.compositeModel,this.searchView.on("Event:SearchVisit",function(t){e.SearchVisit(t)}),this.currentLayout.SearchRegion.show(this.searchView);var n=a.viewModel(this.compositeModel),r=$("#ddlBuses")[0];u.cleanNode(r),u.applyBindings(n,r)},t.prototype.SearchVisit=function(e){var t=this,n=s.GetAll(e);n.done(function(e){return t.GetAllCompleted(e)})},t.prototype.GetAllCompleted=function(e){var t=this,n=o.map(e.busVisitList,function(e){return e.visitDate=r.FormatDateTimeString(e.visitDate),e.returnDate!=undefined&&(e.returnDate=r.FormatDateTimeString(e.returnDate)),e});this.collection=new Backbone.Collection(n),this.collectionView=new i.BusVisitCollectionView({collection:this.collection}),this.collectionView.on("itemview:Event:EditForm",function(e,n){return t.EditForm(n)}),this.currentLayout.ContentRegion.show(this.collectionView)},t.prototype.GetByIdCompleted=function(e){var t=this,n=new Backbone.Model(e.busVisitModel);n.get("visitDate")!=null&&n.get("visitDate").trim()!=""&&n.set("visitDate",r.FormatDateString(n.get("visitDate"))),n.get("returnDate")!=null&&n.get("returnDate").trim()!=""&&n.set("returnDate",r.FormatDateString(n.get("returnDate"))),this.view=new i.BusVisitView(n),this.view.on("Event:SaveForm",function(e){return t.Save(e)}),this.view.on("Event:CancelForm",function(){return t.Cancel()}),this.app.MainRegion.show(this.view)},t.prototype.Save=function(e){var t=this,n=this.app.request("AppGlobalSetting");e.set("modifiedBy",n.get("Id")),e.set("isBookingCompleted",e.get("isBookingCompleted")=="1"?!0:!1);var r=s.Save(e);r.done(function(e){return t.SaveCompleted(e)})},t.prototype.Cancel=function(){window.location.href="#viewBusVisit"},t.prototype.SaveCompleted=function(e){e==undefined?r.ShowModalPopup("danger","Bus Visit","Bus visit have not been saved successfully!"):(r.ShowModalPopup("success","Bus Visit","Record has been saved successfully with Bus Visit ID : "+e.id),this.Cancel())},t}(r.Controller);t.BusVisitCtrl=f});