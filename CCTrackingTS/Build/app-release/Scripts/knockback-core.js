(function(){return function(e){typeof exports=="object"?module.exports=module.exports=e.call(this,require):typeof define=="function"&&define.amd?define(["require","underscore","backbone","knockout"],e):this.kb=e.call(this,typeof require!="undefined"?require:undefined)}(function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F=function(e,t){return function(){return e.apply(t,arguments)}},I=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};d=function(){function e(){}return e.VERSION="0.18.6",e.TYPE_UNKNOWN=0,e.TYPE_SIMPLE=1,e.TYPE_ARRAY=2,e.TYPE_MODEL=3,e.TYPE_COLLECTION=4,e.wasReleased=function(e){return!e||e.__kb_released},e.isReleaseable=function(t,n){var r,i;n==null&&(n=0);if(!t||t!==Object(t)||t.__kb_released)return!1;if(v.isObservable(t)||t instanceof e.ViewModel)return!0;if(typeof t=="function"||t instanceof e.Model||t instanceof e.Collection)return!1;if(typeof t.dispose=="function"||typeof t.destroy=="function"||typeof t.release=="function")return!0;if(n<1)for(r in t){i=t[r];if(r!=="__kb"&&e.isReleaseable(i,n+1))return!0}return!1},e.release=function(t){var n,r,i;if(!e.isReleaseable(t))return;if(g.isArray(t)){for(r in t)i=t[r],e.isReleaseable(i)&&(t[r]=null,e.release(i));return}t.__kb_released=!0;if(v.isObservable(t)&&g.isArray(n=A(t))){if(t.__kb_is_co||t.__kb_is_o&&t.valueType()===s)t.destroy?t.destroy():t.dispose&&t.dispose();else if(n.length)for(r in n)i=n[r],e.isReleaseable(i)&&(n[r]=null,e.release(i))}else typeof t.release=="function"?t.release():typeof t.destroy=="function"?t.destroy():typeof t.dispose=="function"?t.dispose():v.isObservable(t)||this.releaseKeys(t)},e.releaseKeys=function(t){var n,r;for(n in t)r=t[n],n!=="__kb"&&e.isReleaseable(r)&&(t[n]=null,e.release(r))},e.releaseOnNodeRemove=function(t,n){return t||P(this,"missing view model"),n||P(this,"missing node"),v.utils.domNodeDisposal.addDisposeCallback(n,function(){return e.release(t)})},e.renderTemplate=function(t,n,r){var i,s;return r==null&&(r={}),typeof document=="undefined"||document===null?typeof console!="undefined"&&console!==null?console.log("renderTemplate: document is undefined"):void 0:(i=document.createElement("div"),s=v.renderTemplate(t,n,r,i,"replaceChildren"),i.children.length===1&&(i=i.children[0]),e.releaseOnNodeRemove(n,i),s.dispose(),n.afterRender&&!r.afterRender&&n.afterRender(i),i)},e.applyBindings=function(t,n){return v.applyBindings(t,n),e.releaseOnNodeRemove(t,n)},e.getValue=function(t,n,r){if(!t)return;return g.isFunction(t[n])&&e.orm.useFunction(t,n)?t[n]():r?t.get.apply(t,g.map([n].concat(r),function(e){return A(e)})):t.get(n)},e.setValue=function(t,n,r){var i;if(!t)return;return g.isFunction(t[n])&&e.orm.useFunction(t,n)?t[n](r):((i={})[n]=r,t.set(i))},e}(),a=d.TYPE_UNKNOWN,u=d.TYPE_SIMPLE,i=d.TYPE_ARRAY,o=d.TYPE_MODEL,s=d.TYPE_COLLECTION,d.ko=v=this.ko||e("knockout");if(this.Parse)g=this.Parse._;else if(!(g=this._)){M=["lodash","underscore"];for(E=0,C=M.length;E<C;E++){S=M[E];try{g=e(S)}catch(q){}finally{if(g)break}}}d._=g,this.Parse?(d.Parse=this.Parse,d.Collection=this.Parse.Collection,d.Model=this.Parse.Object,d.Events=this.Parse.Events):(d.Backbone=this.Backbone||e("backbone"),d.Collection=d.Backbone.Collection,d.Model=d.Backbone.Model,d.Events=d.Backbone.Events),f=function(){function e(){this.adapters=[]}return e.prototype.initialize=function(){return this.adapters=g.select(this.adapters,function(e){return e.isAvailable()}),this.initialized=!0},e.prototype.addAdapter=function(e){return this.adapters.push(e),this.initialized=!1},e.prototype.keys=function(e){return this._call("keys",arguments)},e.prototype.bind=function(e){return this._call("bind",arguments)},e.prototype.useFunction=function(e){return this._call("useFunction",arguments)},e.prototype._call=function(e,t){var n,r,i,s,o;if(!this.adapters.length)return;this.initialized||this.initialize(),o=this.adapters;for(i=0,s=o.length;i<s;i++){n=o[i];if(n[e]&&(r=n[e].apply(n,t)))return r}},e}(),d.orm=new f,c=function(){function t(){}return t.prototype.isAvailable=function(){var t,n;try{((t=d.Backbone)!=null?t.RelationalModel:void 0)||(typeof e=="function"?e("backbone-relational"):void 0)}catch(r){}return(n=d.Backbone)!=null?!!n.RelationalModel:!!void 0},t.prototype.relationType=function(e,t){var n;return e instanceof d.Backbone.RelationalModel?(n=g.find(e.getRelations(),function(e){return e.key===t}))?n.collectionType||g.isArray(n.keyContents)?s:o:null:null},t.prototype.bind=function(e,t,n,r){var i,o,u,a,f,l;if(!(a=this.relationType(e,t)))return null;u=function(e){return!d.statistics||d.statistics.addModelEvent({name:"update (relational)",model:e,key:t,path:r}),n()},o=Backbone.Relation.prototype.sanitizeOptions?["update","add","remove"]:["change","add","remove"];if(a===s)for(f=0,l=o.length;f<l;f++)i=o[f],e.bind(""+i+":"+t,u);else e.bind(""+o[0]+":"+t,u);return function(){var n,r;if(a===s)for(n=0,r=o.length;n<r;n++)i=o[n],e.unbind(""+i+":"+t,u);else e.unbind(""+o[0]+":"+t,u)}},t}(),d.orm.addAdapter(new c),l=function(){function t(){}return t.prototype.isAvailable=function(){var t,n;try{((t=d.Backbone)!=null?t.AssociatedModel:void 0)||(typeof e=="function"?e("backbone-associations"):void 0)}catch(r){}return(n=d.Backbone)!=null?!!n.AssociatedModel:!!void 0},t.prototype.keys=function(e){return e instanceof d.Backbone.AssociatedModel?g.map(e.relations,function(e){return e.key}):null},t.prototype.relationType=function(e,t){var n;return e instanceof d.Backbone.AssociatedModel?(n=g.find(e.relations,function(e){return e.key===t}))?n.type==="Many"?s:o:null:null},t}(),d.orm.addAdapter(new l),h=function(){function t(){}return t.prototype.isAvailable=function(){try{(typeof window!="undefined"&&window!==null?window.Supermodel:void 0)||(typeof e=="function"?e("supermodel"):void 0)}catch(t){}return typeof window!="undefined"&&window!==null?!!window.Supermodel:!!void 0},t.prototype.keys=function(e){return e instanceof Supermodel.Model?g.keys(e.constructor.associations()):null},t.prototype.relationType=function(e,t){var n;return e instanceof Supermodel.Model?(n=e.constructor.associations()[t])?n.add?s:o:null:null},t.prototype.bind=function(e,t,n,r){var i,s;if(!(s=this.relationType(e,t)))return null;i=function(e,i){var s,o;return!d.statistics||d.statistics.addModelEvent({name:"update (supermodel)",model:e,key:t,path:r}),o=e.constructor.associations()[t],s=e[o.store],e[o.store]=i,n(i),e[o.store]=s};if(s===o)return e.bind("associate:"+t,i),function(){return e.unbind("associate:"+t,i)}},t.prototype.useFunction=function(e,t){return!!this.relationType(e,t)},t}(),d.orm.addAdapter(new h),D=function(e,t){throw""+(g.isString(e)?e:e.constructor.name)+": "+t+" is missing"},P=function(e,t){throw""+(g.isString(e)?e:e.constructor.name)+": "+t+" is unexpected"},N=function(e,t,n){var r;return this._legacy_warnings||(this._legacy_warnings={}),(r=this._legacy_warnings)[e]||(r[e]=0),this._legacy_warnings[e]++,typeof console!="undefined"&&console!==null?console.warn("warning: '"+e+"' has been deprecated (will be removed in Knockback after "+t+"). "+n+"."):void 0},b=Array.prototype.splice,B=v.utils.unwrapObservable,A=function(e){return v.isObservable(e)?e.peek?e.peek():d.ignore(function(){return e()}):e},O=d._publishMethods=function(e,t,n){var r,i,s;for(i=0,s=n.length;i<s;i++)r=n[i],e[r]=d._.bind(t[r],t)},p=function(e,t){var n,r;for(n in t)r=t[n],e[n]=r;return e};var R=function(){},U=function(e,t,n){var r;return t&&t.hasOwnProperty("constructor")?r=t.constructor:r=function(){e.apply(this,arguments)},p(r,e),R.prototype=e.prototype,r.prototype=new R,t&&p(r.prototype,t),n&&p(r,n),r.prototype.constructor=r,r.__super__=e.prototype,r},z=function(e,t){var n=U(this,e,t);return n.extend=this.extend,n};return d.extend=z,j=function(e,t,n){return arguments.length===2?e&&e.__kb&&e.__kb.hasOwnProperty(t)?e.__kb[t]:void 0:(e||P(this,"no obj for wrapping "+t),e.__kb||(e.__kb={}),e.__kb[t]=n,n)},y=function(e,t){return b.call(e,1,0,t),e},H=function(e){var t,n,r;if(!e)return e;if(e.__kb)return"object"in e.__kb?e.__kb.object:e;if(g.isArray(e))return g.map(e,function(e){return H(e)});if(g.isObject(e)&&e.constructor==={}.constructor){n={};for(t in e)r=e[t],n[t]=H(r);return n}return e},k=function(e,t,n){return e[t]||(e[t]=[]),g.isArray(n)||(n=[n]),e[t]=e[t].length?g.union(e[t],n):n,e},L=function(e,t,n){return e[t]||(e[t]={}),g.extend(e[t],n)},x=function(e){var t,n,r,i;n={};for(r=0,i=e.length;r<i;r++)t=e[r],n[t]={key:t};return n},w=function(e){var t,n,r,i;n={},e={options:e};while(e.options){i=e.options;for(t in i){r=i[t];switch(t){case"internals":case"requires":case"excludes":case"statics":k(n,t,r);break;case"keys":g.isObject(r)&&!g.isArray(r)||g.isObject(n[t])&&!g.isArray(n[t])?(g.isObject(r)||(r=[r]),g.isArray(r)&&(r=x(r)),g.isArray(n[t])&&(n[t]=x(n[t])),L(n,t,r)):k(n,t,r);break;case"factories":g.isFunction(r)?n[t]=r:L(n,t,r);break;case"static_defaults":L(n,t,r);break;case"options":break;default:n[t]=r}}e=e.options}return n},d.utils=function(){function e(){}return e.wrappedObservable=function(e,t){return j.apply(this,y(arguments,"observable"))},e.wrappedObject=function(e,t){return j.apply(this,y(arguments,"object"))},e.wrappedModel=function(e,t){return arguments.length===1?(t=j(e,"object"),g.isUndefined(t)?e:t):j(e,"object",t)},e.wrappedStore=function(e,t){return j.apply(this,y(arguments,"store"))},e.wrappedStoreIsOwned=function(e,t){return j.apply(this,y(arguments,"store_is_owned"))},e.wrappedFactory=function(e,t){return j.apply(this,y(arguments,"factory"))},e.wrappedEventWatcher=function(e,t){return j.apply(this,y(arguments,"event_watcher"))},e.wrappedEventWatcherIsOwned=function(e,t){return j.apply(this,y(arguments,"event_watcher_is_owned"))},e.wrappedDestroy=function(e){var t;if(!e.__kb)return;return e.__kb.event_watcher&&e.__kb.event_watcher.releaseCallbacks(e),t=e.__kb,e.__kb=null,t.observable&&(t.observable.destroy=t.observable.release=null,this.wrappedDestroy(t.observable),t.observable=null),t.factory=null,t.event_watcher_is_owned&&t.event_watcher.destroy(),t.event_watcher=null,t.store_is_owned&&t.store.destroy(),t.store=null},e.valueType=function(e){return e?e.__kb_is_o?e.valueType():e.__kb_is_co||e instanceof d.Collection?s:e instanceof d.ViewModel||e instanceof d.Model?o:g.isArray(e)?i:u:a},e.pathJoin=function(e,t){return(e?e[e.length-1]!=="."?""+e+".":e:"")+t},e.optionsPathJoin=function(e,t){return g.defaults({path:this.pathJoin(e.path,t)},e)},e.inferCreator=function(e,t,n,r,i){var s;return t&&(s=t.creatorForPath(e,n)),s?s:e?e instanceof d.Model?d.ViewModel:e instanceof d.Collection?d.CollectionObservable:null:null},e.createFromDefaultCreator=function(e,t){return e instanceof d.Model?d.viewModel(e,t):e instanceof d.Collection?d.collectionObservable(e,t):g.isArray(e)?v.observableArray(e):v.observable(e)},e.hasModelSignature=function(e){return e&&e.attributes&&!e.models&&typeof e.get=="function"&&typeof e.trigger=="function"},e.hasCollectionSignature=function(e){return e&&e.models&&typeof e.get=="function"&&typeof e.trigger=="function"},e.collapseOptions=w,e}(),d.ignore=((_=v.dependencyDetection)!=null?_.ignore:void 0)||function(e,t,n){var r;return r=null,v.dependentObservable(function(){return r=e.apply(t,n||[])}).dispose(),r},d.Factory=function(){function e(e){this.parent_factory=e,this.paths={}}return e.useOptionsOrCreate=function(e,t,n){var r;return e.factory&&(!e.factories||e.factories&&e.factory.hasPathMappings(e.factories,n))?d.utils.wrappedFactory(t,e.factory):(r=d.utils.wrappedFactory(t,new d.Factory(e.factory)),e.factories&&r.addPathMappings(e.factories,n),r)},e.prototype.hasPath=function(e){return this.paths.hasOwnProperty(e)||this.parent_factory&&this.parent_factory.hasPath(e)},e.prototype.addPathMapping=function(e,t){return this.paths[e]=t},e.prototype.addPathMappings=function(e,t){var n,r;for(r in e)n=e[r],this.paths[d.utils.pathJoin(t,r)]=n},e.prototype.hasPathMappings=function(e,t){var n,r,i,s;n=!0;for(s in e)r=e[s],n&=(i=this.creatorForPath(null,d.utils.pathJoin(t,s)))&&r===i;return n},e.prototype.creatorForPath=function(e,t){var n;if(n=this.paths[t])return n.view_model?n.view_model:n;if(this.parent_factory)if(n=this.parent_factory.creatorForPath(e,t))return n;return null},e}(),d.Store=function(){function e(){this.observable_records=[],this.replaced_observables=[]}return e.useOptionsOrCreate=function(e,t,n){return e.store?(e.store.register(t,n,e),d.utils.wrappedStore(n,e.store)):(d.utils.wrappedStoreIsOwned(n,!0),d.utils.wrappedStore(n,new d.Store))},e.prototype.destroy=function(){return this.clear()},e.prototype.clear=function(){var e,t,n,r;r=this.observable_records.splice(0,this.observable_records.length);for(t=0,n=r.length;t<n;t++)e=r[t],d.release(e.observable);d.release(this.replaced_observables)},e.prototype.compact=function(){var e,t,n,r,i;n=[],r=this.observable_records;for(e in r)t=r[e],((i=t.observable)!=null?i.__kb_released:void 0)&&n.push(t);n.length&&(this.observable_records=g.difference(this.observable_records,n))},e.prototype.register=function(e,t,n){var r;if(!t)return;if(v.isObservable(t)||t.__kb_is_co)return;return d.utils.wrappedObject(t,e),e||(t.__kb_null=!0),r=n.creator?n.creator:n.path&&n.factory?n.factory.creatorForPath(e,n.path):null,r||(r=t.constructor),this.observable_records.push({obj:e,observable:t,creator:r}),t},e.prototype.findIndex=function(e,t){var n,r,i,s;i=[];if(!e||e instanceof d.Model){s=this.observable_records;for(n in s){r=s[n];if(!r.observable)continue;if(r.observable.__kb_released){i.push(r);continue}if(!e&&!r.observable.__kb_null||e&&(r.observable.__kb_null||r.obj!==e))continue;if(r.creator===t||r.creator.create&&r.creator.create===t.create)return i.length?(this.observable_records=g.difference(this.observable_records,i),g.indexOf(this.observable_records,r)):n}}return i.length&&(this.observable_records=g.difference(this.observable_records,i)),-1},e.prototype.find=function(e,t){var n;return(n=this.findIndex(e,t))<0?null:this.observable_records[n].observable},e.prototype.isRegistered=function(e){var t,n,r,i;i=this.observable_records;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.observable===e)return!0}return!1},e.prototype.findOrCreate=function(e,t){var n,r;return t.store=this,t.creator||(t.creator=d.utils.inferCreator(e,t.factory,t.path)),!t.creator&&e instanceof d.Model&&(t.creator=d.ViewModel),n=t.creator,n?n.models_only?e:(n&&(r=this.find(e,n)),r?r:(r=d.ignore(function(i){return function(){return n.create?r=n.create(e,t):r=new n(e,t),r||v.observable(null)}}(this)),v.isObservable(r)||this.isRegistered(r)||this.register(e,r,t),r)):d.utils.createFromDefaultCreator(e,t)},e.prototype.findOrReplace=function(e,t,n){var r,i;return e||P(this,"obj missing"),(r=this.findIndex(e,t))<0?this.register(e,n,{creator:t}):(i=this.observable_records[r],d.utils.wrappedObject(i.observable)===e||P(this,"different object"),i.observable!==n&&(i.observable.constructor===n.constructor||P(this,"replacing different type"),this.replaced_observables.push(i.observable),i.observable=n),n)},e}(),d.EventWatcher=function(){function e(e,t,n){this._onModelUnloaded=F(this._onModelUnloaded,this),this._onModelLoaded=F(this._onModelLoaded,this),this.__kb||(this.__kb={}),this.__kb.callbacks={},this.__kb._onModelLoaded=g.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=g.bind(this._onModelUnloaded,this),n&&this.registerCallbacks(t,n),e?this.emitter(e):this.ee=null}return e.useOptionsOrCreate=function(e,t,n,r){return e.event_watcher?(e.event_watcher.emitter()!==t&&e.event_watcher.model_ref!==t&&P(this,"emitter not matching"),d.utils.wrappedEventWatcher(n,e.event_watcher).registerCallbacks(n,r)):(d.utils.wrappedEventWatcherIsOwned(n,!0),d.utils.wrappedEventWatcher(n,new d.EventWatcher(t)).registerCallbacks(n,r))},e.prototype.destroy=function(){return this.emitter(null),this.__kb.callbacks=null,d.utils.wrappedDestroy(this)},e.prototype.emitter=function(e){var t,n,r,i,s,o,u,a;if(arguments.length===0||this.ee===e)return this.ee;this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),d.Backbone&&d.Backbone.ModelRef&&e instanceof d.Backbone.ModelRef?(this.model_ref=e,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),e=this.model_ref.model()):delete this.model_ref,s=this.ee,this.ee=e,a=this.__kb.callbacks;for(n in a){t=a[n],s&&s.unbind(n,t.fn),e&&this.ee.bind(n,t.fn),i=t.list;for(o=0,u=i.length;o<u;o++)r=i[o],r.emitter&&r.emitter(this.ee)}return e},e.prototype.registerCallbacks=function(e,t){var n,r,i,s,o,u,a,f;e||D(this,"obj"),t||D(this,"info"),s=t.event_selector?t.event_selector:"change",i=s.split(" ");for(a=0,f=i.length;a<f;a++){r=i[a];if(!r)continue;n=this.__kb.callbacks[r],n||(u=[],n={list:u,fn:function(e){return function(e){var t,n,i;for(n=0,i=u.length;n<i;n++){t=u[n];if(t.update&&!t.rel_fn){if(e&&t.key&&e.hasChanged&&!e.hasChanged(B(t.key)))continue;!d.statistics||d.statistics.addModelEvent({name:r,model:e,key:t.key,path:t.path}),t.update()}}return null}}(this)},this.__kb.callbacks[r]=n,this.ee&&this.ee.bind(r,n.fn)),o=g.defaults({obj:e},t),n.list.push(o)}this.ee&&(I.call(i,"change")>=0&&(o.unbind_fn=d.orm.bind(this.ee,o.key,o.update,o.path)),o.emitter(this.ee)&&o.emitter)},e.prototype.releaseCallbacks=function(e){var t,n,r,i,s,o;if(!this.__kb.callbacks||!this.ee)return;s=this.__kb.callbacks;for(n in s){t=s[n],o=t.list;for(r in o){i=o[r];if(i.obj!==e)continue;t.list.splice(r,1),i.unbind_fn&&(i.unbind_fn(),i.unbind_fn=null),!d.wasReleased(e)&&i.emitter&&i.emitter(null);return}}},e.prototype._onModelLoaded=function(e){var t,n,r,i,s,o,u;this.ee=e,o=this.__kb.callbacks;for(n in o){t=o[n],e.bind(n,t.fn),u=t.list;for(i=0,s=u.length;i<s;i++)r=u[i],r.unbind_fn=d.orm.bind(e,r.key,r.update,r.path),r.emitter&&r.emitter(e)}},e.prototype._onModelUnloaded=function(e){var t,n,r,i,s,o,u;this.ee=null,u=this.__kb.callbacks;for(n in u){t=u[n],e.unbind(n,t.fn),i=t.list;for(s=0,o=i.length;s<o;s++)r=i[s],r.unbind_fn&&(r.unbind_fn(),r.unbind_fn=null),r.emitter&&r.emitter(null)}},e}(),d.emitterObservable=function(e,t){return new d.EventWatcher(e,t)},d.Observable=function(){function e(e,t,n){return this._vm=n!=null?n:{},d.ignore(function(n){return function(){var r,i,s;return t||D(n,"options"),g.isString(t)||v.isObservable(t)?r=n.create_options={key:t}:r=n.create_options=w(t),n.key=r.key,delete r.key,n.key||D(n,"key"),!r.args||(n.args=r.args,delete r.args),!r.read||(n.read=r.read,delete r.read),!r.write||(n.write=r.write,delete r.write),i=r.event_watcher,delete r.event_watcher,n._vo=v.observable(null),n._model=v.observable(),s=d.utils.wrappedObservable(n,v.dependentObservable({read:function(){var e,t,r,i,s,o;s=n._model(),o=t=[n.key].concat(n.args||[]);for(r=0,i=o.length;r<i;r++)e=o[r],B(e);return n.read?n.update(n.read.apply(n._vm,t)):g.isUndefined(s)||d.ignore(function(){return n.update(d.getValue(s,A(n.key),n.args))}),B(n._vo())},write:function(e){return d.ignore(function(){var t,r;return t=H(e),r=A(n._model),n.write?(n.write.call(n._vm,t),e=d.getValue(r,A(n.key),n.args)):r&&d.setValue(r,A(n.key),t),n.update(e)})},owner:n._vm})),s.__kb_is_o=!0,r.store=d.utils.wrappedStore(s,r.store),r.path=d.utils.pathJoin(r.path,n.key),r.factories&&(typeof r.factories=="function"||r.factories.create)?(r.factory=d.utils.wrappedFactory(s,new d.Factory(r.factory)),r.factory.addPathMapping(r.path,r.factories)):r.factory=d.Factory.useOptionsOrCreate(r,s,r.path),delete r.factories,O(s,n,["value","valueType","destroy"]),s.model=n.model=v.dependentObservable({read:function(){return B(n._model)},write:function(e){return d.ignore(function(){var t;if(n.__kb_released||A(n._model)===e)return;t=d.getValue(e,A(n.key),n.args),n._model(e);if(!e)return n.update(null);if(!g.isUndefined(t))return n.update(t)})}}),d.EventWatcher.useOptionsOrCreate({event_watcher:i},e,n,{emitter:n.model,update:g.bind(n.update,n),key:n.key,path:r.path}),n.__kb_value||n.update(),d.LocalizedObservable&&r.localizer&&(s=new r.localizer(s),delete r.localizer),d.DefaultObservable&&r.hasOwnProperty("default")&&(s=d.defaultObservable(s,r["default"]),delete r["default"]),s}}(this))}return e.prototype.destroy=function(){var e;return e=d.utils.wrappedObservable(this),this.__kb_released=!0,d.release(this.__kb_value),this.__kb_value=null,this.model.dispose(),this.model=e.model=null,d.utils.wrappedDestroy(this)},e.prototype.value=function(){return this.__kb_value},e.prototype.valueType=function(){var e;return e=d.getValue(A(this._model),A(this.key)),this.value_type||this._updateValueObservable(e),this.value_type},e.prototype.update=function(e){var t,n;if(this.__kb_released)return;arguments.length||(e=d.getValue(A(this._model),A(this.key))),e!==void 0||(e=null),t=d.utils.valueType(e);if(!this.__kb_value||this.__kb_value.__kb_released||this.__kb_value.__kb_null&&e)this.__kb_value=void 0,this.value_type=void 0;n=this.__kb_value;if(g.isUndefined(this.value_type)||this.value_type!==t&&t!==a)return this.value_type===s&&t===i?n(e):this._updateValueObservable(e);if(this.value_type===o){if(typeof n.model=="function"){if(n.model()!==e)return n.model(e)}else if(d.utils.wrappedObject(n)!==e)return this._updateValueObservable(e)}else if(this.value_type===s){if(n.collection()!==e)return n.collection(e)}else if(n()!==e)return n(e)},e.prototype._updateValueObservable=function(e){var t,n,r,f;return t=this.create_options,t.creator=d.utils.inferCreator(e,t.factory,t.path,A(this._model),this.key),this.value_type=a,n=t.creator,r=this.__kb_value,this.__kb_value=void 0,r&&d.release(r),n?t.store?f=t.store.findOrCreate(e,t):n.models_only?(f=e,this.value_type=u):n.create?f=n.create(e,t):f=new n(e,t):g.isArray(e)?(this.value_type=i,f=v.observableArray(e)):(this.value_type=u,f=v.observable(e)),this.value_type===a&&(v.isObservable(f)?f.__kb_is_co?this.value_type=s:this.value_type=u:(this.value_type=o,typeof f.model!="function"&&d.utils.wrappedObject(f,e))),this.__kb_value=f,this._vo(f)},e}(),d.observable=function(e,t,n){return new d.Observable(e,t,n)},d.ViewModel=function(){function e(e,t,n){return d.ignore(function(r){return function(){var i,s,o,u,a,f,l,c,h,p;!e||e instanceof d.Model||typeof e.get=="function"&&typeof e.bind=="function"||P(r,"not a model"),t||(t={}),n||(n={}),g.isArray(t)?t={keys:t}:t=w(t),r.__kb||(r.__kb={}),r.__kb.vm_keys={},r.__kb.model_keys={},r.__kb.view_model=g.isUndefined(n)?r:n,!t.internals||(r.__kb.internals=t.internals),!t.excludes||(r.__kb.excludes=t.excludes),!t.statics||(r.__kb.statics=t.statics),!t.static_defaults||(r.__kb.static_defaults=t.static_defaults),d.Store.useOptionsOrCreate(t,e,r),r.__kb.path=t.path,d.Factory.useOptionsOrCreate(t,r,t.path),h=j(r,"_mdl",v.observable()),r.model=v.dependentObservable({read:function(){return h(),d.utils.wrappedObject(r)},write:function(e){return d.ignore(function(){var t,n,i,s;if(d.utils.wrappedObject(r)===e)return;if(r.__kb_null){!e||P(r,"model set on shared null");return}d.utils.wrappedObject(r,e),t=d.utils.wrappedEventWatcher(r);if(!t){h(e);return}t.emitter(e),r.__kb.keys||!e||!e.attributes||(n=g.keys(e.attributes),e&&(s=d.orm.keys(e))&&(n=g.union(n,s)),i=g.difference(n,g.keys(r.__kb.model_keys)),i&&r.createObservables(e,i)),h(e)})}}),o=d.utils.wrappedEventWatcher(r,new d.EventWatcher(e,r,{emitter:r.model})),u=t.requires,r.__kb.internals&&(u=g.union(u||[],r.__kb.internals)),e&&(l=d.orm.keys(e))&&(u=g.union(u||[],l));if(t.keys)if(g.isObject(t.keys)&&!g.isArray(t.keys)){a={},p=t.keys;for(c in p)f=p[c],a[g.isString(f)?f:f.key?f.key:c]=!0;r.__kb.keys=g.keys(a)}else r.__kb.keys=t.keys,u=u?g.union(u,r.__kb.keys):g.clone(r.__kb.keys);else s=o.emitter(),s&&s.attributes&&(i=g.keys(s.attributes),u=u?g.union(u,i):i);return u&&r.__kb.excludes&&(u=g.difference(u,r.__kb.excludes)),u&&r.__kb.statics&&(u=g.difference(u,r.__kb.statics)),g.isObject(t.keys)&&!g.isArray(t.keys)&&r.mapObservables(e,t.keys),g.isObject(t.requires)&&!g.isArray(t.requires)&&r.mapObservables(e,t.requires),!t.mappings||r.mapObservables(e,t.mappings),!u||r.createObservables(e,u),!r.__kb.statics||r.createObservables(e,r.__kb.statics,!0),!d.statistics||d.statistics.register("ViewModel",r),r}}(this))}return e.extend=d.extend,e.prototype.destroy=function(){var e;if(this.__kb.view_model!==this)for(e in this.__kb.vm_keys)this.__kb.view_model[e]=null;return this.__kb.view_model=null,d.releaseKeys(this),d.utils.wrappedDestroy(this),!d.statistics||d.statistics.unregister("ViewModel",this)},e.prototype.shareOptions=function(){return{store:d.utils.wrappedStore(this),factory:d.utils.wrappedFactory(this)}},e.prototype.createObservables=function(e,t,n){var r,i,s,o,u,a;n?s=this.__kb.static_defaults||{}:r={store:d.utils.wrappedStore(this),factory:d.utils.wrappedFactory(this),path:this.__kb.path,event_watcher:d.utils.wrappedEventWatcher(this)};for(u=0,a=t.length;u<a;u++){i=t[u],o=this.__kb.internals&&g.contains(this.__kb.internals,i)?"_"+i:i;if(this[o])continue;this.__kb.vm_keys[o]=this.__kb.model_keys[i]=!0,n?e.has(o)?this[o]=this.__kb.view_model[o]=e.get(o):o in s&&(this[o]=this.__kb.view_model[o]=s[o]):(r.key=i,this[o]=this.__kb.view_model[o]=d.observable(e,r,this))}},e.prototype.mapObservables=function(e,t){var n,r,i;n={store:d.utils.wrappedStore(this),factory:d.utils.wrappedFactory(this),path:this.__kb.path,event_watcher:d.utils.wrappedEventWatcher(this)};for(i in t){r=t[i];if(this[i])continue;r=g.isString(r)?{key:r}:g.clone(r),r.key||(r.key=i),this.__kb.vm_keys[i]=this.__kb.model_keys[r.key]=!0,this[i]=this.__kb.view_model[i]=d.observable(e,g.defaults(r,n),this)}},e}(),d.viewModel=function(e,t,n){return new d.ViewModel(e,t,n)},r=0,t=-1,n=1,d.compare=function(e,i){return g.isString(e)?e.localeCompare(""+i):g.isString(i)?i.localeCompare(""+e):e===i?r:e<i?t:n},d.CollectionObservable=function(){function e(e,t){return d.ignore(function(n){return function(){var r,i,s;return!g.isUndefined(t)||e instanceof d.Collection?g.isArray(e)&&(e=new d.Collection(e)):(s=[new d.Collection,e],e=s[0],t=s[1]),t||(t={}),i=d.utils.wrappedObservable(n,v.observableArray([])),i.__kb_is_co=!0,n.in_edit=0,n.__kb||(n.__kb={}),n.__kb._onCollectionChange=g.bind(n._onCollectionChange,n),t=w(t),t.auto_compact&&(n.auto_compact=!0),t.sort_attribute?n._comparator=v.observable(n._attributeComparator(t.sort_attribute)):n._comparator=v.observable(t.comparator),t.filters?n._filters=v.observableArray(g.isArray(t.filters)?t.filters:t.filters?[t.filters]:void 0):n._filters=v.observableArray([]),r=n.create_options={store:d.Store.useOptionsOrCreate(t,e,i)},n.path=t.path,r.factory=d.utils.wrappedFactory(i,n._shareOrCreateFactory(t)),r.path=d.utils.pathJoin(t.path,"models"),r.creator=r.factory.creatorForPath(null,r.path),r.creator&&(n.models_only=r.creator.models_only),O(i,n,["destroy","shareOptions","filters","comparator","sortAttribute","viewModelByModel","hasViewModels"]),n._collection=v.observable(e),i.collection=n.collection=v.dependentObservable({read:function(){return n._collection()},write:function(e){return d.ignore(function(){var t;if((t=n._collection())===e)return;return t&&t.unbind("all",n.__kb._onCollectionChange),e&&e.bind("all",n.__kb._onCollectionChange),n._collection(e)})}}),e&&e.bind("all",n.__kb._onCollectionChange),n._mapper=v.dependentObservable(function(){var e,t,r,s,o,u,a,f;e=n._comparator(),s=n._filters();if(s)for(a=0,f=s.length;a<f;a++)r=s[a],B(r);t=n._collection();if(n.in_edit)return;return i=d.utils.wrappedObservable(n),t&&(o=t.models),!o||t.models.length===0?u=[]:(o=g.filter(o,function(e){return!s.length||n._selectModel(e)}),e?u=g.map(o,function(e){return n._createViewModel(e)}).sort(e):n.models_only?u=s.length?o:o.slice():u=g.map(o,function(e){return n._createViewModel(e)})),n.in_edit++,i(u),n.in_edit--}),i.subscribe(g.bind(n._onObservableArrayChange,n)),!d.statistics||d.statistics.register("CollectionObservable",n),i}}(this))}return e.extend=d.extend,e.prototype.destroy=function(){var e,t,n;return n=d.utils.wrappedObservable(this),t=this._collection(),t&&(t.unbind("all",this.__kb._onCollectionChange),e=n(),e.splice(0,e.length)),this.collection.dispose(),this._collection=n.collection=this.collection=null,this._mapper.dispose(),this._mapper=null,d.release(this._filters),this._filters=null,this._comparator(null),this._comparator=null,this.create_options=null,n.collection=null,d.utils.wrappedDestroy(this),!d.statistics||d.statistics.unregister("CollectionObservable",this)},e.prototype.shareOptions=function(){var e;return e=d.utils.wrappedObservable(this),{store:d.utils.wrappedStore(e),factory:d.utils.wrappedFactory(e)}},e.prototype.filters=function(e){return e?this._filters(g.isArray(e)?e:[e]):this._filters([])},e.prototype.comparator=function(e){return this._comparator(e)},e.prototype.sortAttribute=function(e){return this._comparator(e?this._attributeComparator(e):null)},e.prototype.viewModelByModel=function(e){var t;return this.models_only?null:(t=e.hasOwnProperty(e.idAttribute)?e.idAttribute:"cid",g.find(A(d.utils.wrappedObservable(this)),function(n){var r;return(n!=null?(r=n.__kb)!=null?r.object:void 0:void 0)?n.__kb.object[t]===e[t]:!1}))},e.prototype.hasViewModels=function(){return!this.models_only},e.prototype.compact=function(){return d.ignore(function(e){return function(){var t;t=d.utils.wrappedObservable(e);if(!d.utils.wrappedStoreIsOwned(t))return;return d.utils.wrappedStore(t).clear(),e._collection.notifySubscribers(e._collection())}}(this))},e.prototype._shareOrCreateFactory=function(e){var t,n,r,i;t=d.utils.pathJoin(e.path,"models"),r=e.factories;if(i=e.factory)if((n=i.creatorForPath(null,t))&&(!r||r.models===n)){if(!r)return i;if(i.hasPathMappings(r,e.path))return i}return i=new d.Factory(e.factory),r&&i.addPathMappings(r,e.path),i.creatorForPath(null,t)||(e.hasOwnProperty("models_only")?e.models_only?i.addPathMapping(t,{models_only:!0}):i.addPathMapping(t,d.ViewModel):e.view_model?i.addPathMapping(t,e.view_model):e.create?i.addPathMapping(t,{create:e.create}):i.addPathMapping(t,d.ViewModel)),i},e.prototype._onCollectionChange=function(e,t){return d.ignore(function(n){return function(){var r,i,s,o;if(n.in_edit)return;switch(e){case"reset":n.auto_compact?n.compact():n._collection.notifySubscribers(n._collection());break;case"sort":case"resort":n._collection.notifySubscribers(n._collection());break;case"new":case"add":if(!n._selectModel(t))return;s=d.utils.wrappedObservable(n),r=n._collection();if(r.indexOf(t)===-1)return;if(o=n.viewModelByModel(t))return;n.in_edit++,o=n._createViewModel(t),(i=n._comparator())?(s().push(o),s.sort(i)):s.splice(r.indexOf(t),0,o),n.in_edit--;break;case"remove":case"destroy":n._onModelRemove(t);break;case"change":if(!n._selectModel(t))n._onModelRemove(t);else{o=n.models_only?t:n.viewModelByModel(t);if(o){if(i=n._comparator())s=d.utils.wrappedObservable(n),n.in_edit++,s.sort(i),n.in_edit--}else n._onCollectionChange("add",t)}}}}(this))},e.prototype._onModelRemove=function(e){var t,n;n=this.models_only?e:this.viewModelByModel(e);if(!n)return;return t=d.utils.wrappedObservable(this),this.in_edit++,t.remove(n),this.in_edit--},e.prototype._onObservableArrayChange=function(e){return d.ignore(function(t){return function(){var n,r,i,s,o,u,a,f,l;if(t.in_edit)return;t.models_only&&(!e.length||d.utils.hasModelSignature(e[0]))||!t.models_only&&(!e.length||g.isObject(e[0])&&!d.utils.hasModelSignature(e[0]))||P(t,"incorrect type passed"),o=d.utils.wrappedObservable(t),n=A(t._collection),r=A(t._filters).length;if(!n)return;a=e;if(t.models_only)s=g.filter(e,function(e){return!r||t._selectModel(e)});else{!r||(a=[]),s=[];for(f=0,l=e.length;f<l;f++){u=e[f],i=d.utils.wrappedObject(u);if(r){if(!t._selectModel(i))continue;a.push(u)}t.create_options.store.findOrReplace(i,t.create_options.creator,u),s.push(i)}}t.in_edit++,e.length===a.length||o(a),g.isEqual(n.models,s)||n.reset(s),t.in_edit--}}(this))},e.prototype._attributeComparator=function(e){var t;return t=function(t,n){var r;return r=B(e),d.compare(t.get(r),n.get(r))},this.models_only?t:function(e,n){return t(d.utils.wrappedModel(e),d.utils.wrappedModel(n))}},e.prototype._createViewModel=function(e){return this.models_only?e:this.create_options.store.findOrCreate(e,this.create_options)},e.prototype._selectModel=function(e){var t,n,r,i,s;n=A(this._filters);for(r=0,i=n.length;r<i;r++){t=n[r],t=A(t);if(g.isFunction(t)){if(!t(e))return!1}else if(g.isArray(t)){if(s=e.id,I.call(t,s)<0)return!1}else if(e.id!==t)return!1}return!0},e}(),d.collectionObservable=function(e,t){return new d.CollectionObservable(e,t)},d.RECUSIVE_AUTO_INJECT=!0,v.bindingHandlers.inject={init:function(e,t,n,r){return d.Inject.inject(B(t()),r,e,t,n)}},d.Inject=function(){function e(){}return e.inject=function(e,t,n,r,i,s){var o,u,a;return o=function(e){var o,u,a;if(g.isFunction(e))t=new e(t,n,r,i),d.releaseOnNodeRemove(t,n);else{e.view_model&&(t=new e.view_model(t,n,r,i),d.releaseOnNodeRemove(t,n));for(o in e){a=e[o];if(o==="view_model")continue;o==="create"?a(t,n,r,i):g.isObject(a)&&!g.isFunction(a)?(u=s||a&&a.create?{}:t,t[o]=d.Inject.inject(a,u,n,r,i,!0)):t[o]=a}}return t},s?o(e):(u=(a=v.dependentObservable(function(){return o(e)}))(),a.dispose(),u)},e.injectViewModels=function(e){var t,n,r,i,s,o,u,a,f,l;a=[],o=function(e){var t,n,r,i,s;e.__kb_injected||e.attributes&&(t=g.find(e.attributes,function(e){return e.name==="kb-inject"}))&&(e.__kb_injected=!0,a.push({el:e,view_model:{},binding:t.value})),s=e.childNodes;for(r=0,i=s.length;r<i;r++)n=s[r],o(n)},!e&&typeof document!="undefined"&&document!==null&&(e=document),o(e);for(f=0,l=a.length;f<l;f++){n=a[f];if(s=n.binding)s.search(/[:]/)<0||(s="{"+s+"}"),i=(new Function("","return ( "+s+" )"))(),i||(i={}),!i.options||(u=i.options,delete i.options),u||(u={}),n.view_model=d.Inject.inject(i,n.view_model,n.el,null,null,!0),t=n.view_model.afterBinding||u.afterBinding,r=n.view_model.beforeBinding||u.beforeBinding;r&&r(n.view_model,n.el,u),d.applyBindings(n.view_model,n.el,u),t&&t(n.view_model,n.el,u)}return a},e}(),T=v.applyBindings,v.applyBindings=function(e,t){var n;n=d.RECUSIVE_AUTO_INJECT?d.injectViewModels(t):[];if(!n.length)return T.apply(this,arguments)},d.injectViewModels=d.Inject.injectViewModels,typeof document!="undefined"&&document!==null&&(this.$?this.$(function(){return d.injectViewModels()}):(m=function(){return document.readyState!=="complete"?setTimeout(m,0):d.injectViewModels()})()),d})}).call(this);