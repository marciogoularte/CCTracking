(function(){return function(e){typeof define=="function"&&define.amd?define(["require","underscore","backbone","knockout"],e):typeof exports=="object"?module.exports=module.exports=e.call(this,require):this.kb=e.call(this,typeof require!="undefined"?require:undefined)}(function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z=function(e,t){return function(){return e.apply(t,arguments)}},W=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};b=function(){function e(){}return e.VERSION="0.18.6",e.TYPE_UNKNOWN=0,e.TYPE_SIMPLE=1,e.TYPE_ARRAY=2,e.TYPE_MODEL=3,e.TYPE_COLLECTION=4,e.wasReleased=function(e){return!e||e.__kb_released},e.isReleaseable=function(t,n){var r,i;n==null&&(n=0);if(!t||t!==Object(t)||t.__kb_released)return!1;if(w.isObservable(t)||t instanceof e.ViewModel)return!0;if(typeof t=="function"||t instanceof e.Model||t instanceof e.Collection)return!1;if(typeof t.dispose=="function"||typeof t.destroy=="function"||typeof t.release=="function")return!0;if(n<1)for(r in t){i=t[r];if(r!=="__kb"&&e.isReleaseable(i,n+1))return!0}return!1},e.release=function(t){var n,r,i;if(!e.isReleaseable(t))return;if(S.isArray(t)){for(r in t)i=t[r],e.isReleaseable(i)&&(t[r]=null,e.release(i));return}t.__kb_released=!0;if(w.isObservable(t)&&S.isArray(n=P(t))){if(t.__kb_is_co||t.__kb_is_o&&t.valueType()===o)t.destroy?t.destroy():t.dispose&&t.dispose();else if(n.length)for(r in n)i=n[r],e.isReleaseable(i)&&(n[r]=null,e.release(i))}else typeof t.release=="function"?t.release():typeof t.destroy=="function"?t.destroy():typeof t.dispose=="function"?t.dispose():w.isObservable(t)||this.releaseKeys(t)},e.releaseKeys=function(t){var n,r;for(n in t)r=t[n],n!=="__kb"&&e.isReleaseable(r)&&(t[n]=null,e.release(r))},e.releaseOnNodeRemove=function(t,n){return t||I(this,"missing view model"),n||I(this,"missing node"),w.utils.domNodeDisposal.addDisposeCallback(n,function(){return e.release(t)})},e.renderTemplate=function(t,n,r){var i,s;return r==null&&(r={}),typeof document=="undefined"||document===null?typeof console!="undefined"&&console!==null?console.log("renderTemplate: document is undefined"):void 0:(i=document.createElement("div"),s=w.renderTemplate(t,n,r,i,"replaceChildren"),i.children.length===1&&(i=i.children[0]),e.releaseOnNodeRemove(n,i),s.dispose(),n.afterRender&&!r.afterRender&&n.afterRender(i),i)},e.applyBindings=function(t,n){return w.applyBindings(t,n),e.releaseOnNodeRemove(t,n)},e.getValue=function(t,n,r){if(!t)return;return S.isFunction(t[n])&&e.orm.useFunction(t,n)?t[n]():r?t.get.apply(t,S.map([n].concat(r),function(e){return P(e)})):t.get(n)},e.setValue=function(t,n,r){var i;if(!t)return;return S.isFunction(t[n])&&e.orm.useFunction(t,n)?t[n](r):((i={})[n]=r,t.set(i))},e}(),f=b.TYPE_UNKNOWN,a=b.TYPE_SIMPLE,s=b.TYPE_ARRAY,u=b.TYPE_MODEL,o=b.TYPE_COLLECTION,b.ko=w=this.ko||e("knockout");if(this.Parse)S=this.Parse._;else if(!(S=this._)){B=["lodash","underscore"];for(C=0,M=B.length;C<M;C++){k=B[C];try{S=e(k)}catch(X){}finally{if(S)break}}}b._=S,this.Parse?(b.Parse=this.Parse,b.Collection=this.Parse.Collection,b.Model=this.Parse.Object,b.Events=this.Parse.Events):(b.Backbone=this.Backbone||e("backbone"),b.Collection=b.Backbone.Collection,b.Model=b.Backbone.Model,b.Events=b.Backbone.Events),c=function(){function e(){this.adapters=[]}return e.prototype.initialize=function(){return this.adapters=S.select(this.adapters,function(e){return e.isAvailable()}),this.initialized=!0},e.prototype.addAdapter=function(e){return this.adapters.push(e),this.initialized=!1},e.prototype.keys=function(e){return this._call("keys",arguments)},e.prototype.bind=function(e){return this._call("bind",arguments)},e.prototype.useFunction=function(e){return this._call("useFunction",arguments)},e.prototype._call=function(e,t){var n,r,i,s,o;if(!this.adapters.length)return;this.initialized||this.initialize(),o=this.adapters;for(i=0,s=o.length;i<s;i++){n=o[i];if(n[e]&&(r=n[e].apply(n,t)))return r}},e}(),b.orm=new c,p=function(){function t(){}return t.prototype.isAvailable=function(){var t,n;try{((t=b.Backbone)!=null?t.RelationalModel:void 0)||(typeof e=="function"?e("backbone-relational"):void 0)}catch(r){}return(n=b.Backbone)!=null?!!n.RelationalModel:!!void 0},t.prototype.relationType=function(e,t){var n;return e instanceof b.Backbone.RelationalModel?(n=S.find(e.getRelations(),function(e){return e.key===t}))?n.collectionType||S.isArray(n.keyContents)?o:u:null:null},t.prototype.bind=function(e,t,n,r){var i,s,u,a,f,l;if(!(a=this.relationType(e,t)))return null;u=function(e){return!b.statistics||b.statistics.addModelEvent({name:"update (relational)",model:e,key:t,path:r}),n()},s=Backbone.Relation.prototype.sanitizeOptions?["update","add","remove"]:["change","add","remove"];if(a===o)for(f=0,l=s.length;f<l;f++)i=s[f],e.bind(""+i+":"+t,u);else e.bind(""+s[0]+":"+t,u);return function(){var n,r;if(a===o)for(n=0,r=s.length;n<r;n++)i=s[n],e.unbind(""+i+":"+t,u);else e.unbind(""+s[0]+":"+t,u)}},t}(),b.orm.addAdapter(new p),h=function(){function t(){}return t.prototype.isAvailable=function(){var t,n;try{((t=b.Backbone)!=null?t.AssociatedModel:void 0)||(typeof e=="function"?e("backbone-associations"):void 0)}catch(r){}return(n=b.Backbone)!=null?!!n.AssociatedModel:!!void 0},t.prototype.keys=function(e){return e instanceof b.Backbone.AssociatedModel?S.map(e.relations,function(e){return e.key}):null},t.prototype.relationType=function(e,t){var n;return e instanceof b.Backbone.AssociatedModel?(n=S.find(e.relations,function(e){return e.key===t}))?n.type==="Many"?o:u:null:null},t}(),b.orm.addAdapter(new h),d=function(){function t(){}return t.prototype.isAvailable=function(){try{(typeof window!="undefined"&&window!==null?window.Supermodel:void 0)||(typeof e=="function"?e("supermodel"):void 0)}catch(t){}return typeof window!="undefined"&&window!==null?!!window.Supermodel:!!void 0},t.prototype.keys=function(e){return e instanceof Supermodel.Model?S.keys(e.constructor.associations()):null},t.prototype.relationType=function(e,t){var n;return e instanceof Supermodel.Model?(n=e.constructor.associations()[t])?n.add?o:u:null:null},t.prototype.bind=function(e,t,n,r){var i,s;if(!(s=this.relationType(e,t)))return null;i=function(e,i){var s,o;return!b.statistics||b.statistics.addModelEvent({name:"update (supermodel)",model:e,key:t,path:r}),o=e.constructor.associations()[t],s=e[o.store],e[o.store]=i,n(i),e[o.store]=s};if(s===u)return e.bind("associate:"+t,i),function(){return e.unbind("associate:"+t,i)}},t.prototype.useFunction=function(e,t){return!!this.relationType(e,t)},t}(),b.orm.addAdapter(new d),F=function(e,t){throw""+(S.isString(e)?e:e.constructor.name)+": "+t+" is missing"},I=function(e,t){throw""+(S.isString(e)?e:e.constructor.name)+": "+t+" is unexpected"},O=function(e,t,n){var r;return this._legacy_warnings||(this._legacy_warnings={}),(r=this._legacy_warnings)[e]||(r[e]=0),this._legacy_warnings[e]++,typeof console!="undefined"&&console!==null?console.warn("warning: '"+e+"' has been deprecated (will be removed in Knockback after "+t+"). "+n+"."):void 0},T=Array.prototype.splice,R=w.utils.unwrapObservable,P=function(e){return w.isObservable(e)?e.peek?e.peek():b.ignore(function(){return e()}):e},H=b._publishMethods=function(e,t,n){var r,i,s;for(i=0,s=n.length;i<s;i++)r=n[i],e[r]=b._.bind(t[r],t)},y=function(e,t){var n,r;for(n in t)r=t[n],e[n]=r;return e};var V=function(){},J=function(e,t,n){var r;return t&&t.hasOwnProperty("constructor")?r=t.constructor:r=function(){e.apply(this,arguments)},y(r,e),V.prototype=e.prototype,r.prototype=new V,t&&y(r.prototype,t),n&&y(r,n),r.prototype.constructor=r,r.__super__=e.prototype,r},K=function(e,t){var n=J(this,e,t);return n.extend=this.extend,n};return b.extend=K,U=function(e,t,n){return arguments.length===2?e&&e.__kb&&e.__kb.hasOwnProperty(t)?e.__kb[t]:void 0:(e||I(this,"no obj for wrapping "+t),e.__kb||(e.__kb={}),e.__kb[t]=n,n)},x=function(e,t){return T.call(e,1,0,t),e},q=function(e){var t,n,r;if(!e)return e;if(e.__kb)return"object"in e.__kb?e.__kb.object:e;if(S.isArray(e))return S.map(e,function(e){return q(e)});if(S.isObject(e)&&e.constructor==={}.constructor){n={};for(t in e)r=e[t],n[t]=q(r);return n}return e},_=function(e,t,n){return e[t]||(e[t]=[]),S.isArray(n)||(n=[n]),e[t]=e[t].length?S.union(e[t],n):n,e},D=function(e,t,n){return e[t]||(e[t]={}),S.extend(e[t],n)},L=function(e){var t,n,r,i;n={};for(r=0,i=e.length;r<i;r++)t=e[r],n[t]={key:t};return n},N=function(e){var t,n,r,i;n={},e={options:e};while(e.options){i=e.options;for(t in i){r=i[t];switch(t){case"internals":case"requires":case"excludes":case"statics":_(n,t,r);break;case"keys":S.isObject(r)&&!S.isArray(r)||S.isObject(n[t])&&!S.isArray(n[t])?(S.isObject(r)||(r=[r]),S.isArray(r)&&(r=L(r)),S.isArray(n[t])&&(n[t]=L(n[t])),D(n,t,r)):_(n,t,r);break;case"factories":S.isFunction(r)?n[t]=r:D(n,t,r);break;case"static_defaults":D(n,t,r);break;case"options":break;default:n[t]=r}}e=e.options}return n},b.utils=function(){function e(){}return e.wrappedObservable=function(e,t){return U.apply(this,x(arguments,"observable"))},e.wrappedObject=function(e,t){return U.apply(this,x(arguments,"object"))},e.wrappedModel=function(e,t){return arguments.length===1?(t=U(e,"object"),S.isUndefined(t)?e:t):U(e,"object",t)},e.wrappedStore=function(e,t){return U.apply(this,x(arguments,"store"))},e.wrappedStoreIsOwned=function(e,t){return U.apply(this,x(arguments,"store_is_owned"))},e.wrappedFactory=function(e,t){return U.apply(this,x(arguments,"factory"))},e.wrappedEventWatcher=function(e,t){return U.apply(this,x(arguments,"event_watcher"))},e.wrappedEventWatcherIsOwned=function(e,t){return U.apply(this,x(arguments,"event_watcher_is_owned"))},e.wrappedDestroy=function(e){var t;if(!e.__kb)return;return e.__kb.event_watcher&&e.__kb.event_watcher.releaseCallbacks(e),t=e.__kb,e.__kb=null,t.observable&&(t.observable.destroy=t.observable.release=null,this.wrappedDestroy(t.observable),t.observable=null),t.factory=null,t.event_watcher_is_owned&&t.event_watcher.destroy(),t.event_watcher=null,t.store_is_owned&&t.store.destroy(),t.store=null},e.valueType=function(e){return e?e.__kb_is_o?e.valueType():e.__kb_is_co||e instanceof b.Collection?o:e instanceof b.ViewModel||e instanceof b.Model?u:S.isArray(e)?s:a:f},e.pathJoin=function(e,t){return(e?e[e.length-1]!=="."?""+e+".":e:"")+t},e.optionsPathJoin=function(e,t){return S.defaults({path:this.pathJoin(e.path,t)},e)},e.inferCreator=function(e,t,n,r,i){var s;return t&&(s=t.creatorForPath(e,n)),s?s:e?e instanceof b.Model?b.ViewModel:e instanceof b.Collection?b.CollectionObservable:null:null},e.createFromDefaultCreator=function(e,t){return e instanceof b.Model?b.viewModel(e,t):e instanceof b.Collection?b.collectionObservable(e,t):S.isArray(e)?w.observableArray(e):w.observable(e)},e.hasModelSignature=function(e){return e&&e.attributes&&!e.models&&typeof e.get=="function"&&typeof e.trigger=="function"},e.hasCollectionSignature=function(e){return e&&e.models&&typeof e.get=="function"&&typeof e.trigger=="function"},e.collapseOptions=N,e}(),b.ignore=((j=w.dependencyDetection)!=null?j.ignore:void 0)||function(e,t,n){var r;return r=null,w.dependentObservable(function(){return r=e.apply(t,n||[])}).dispose(),r},b.Factory=function(){function e(e){this.parent_factory=e,this.paths={}}return e.useOptionsOrCreate=function(e,t,n){var r;return e.factory&&(!e.factories||e.factories&&e.factory.hasPathMappings(e.factories,n))?b.utils.wrappedFactory(t,e.factory):(r=b.utils.wrappedFactory(t,new b.Factory(e.factory)),e.factories&&r.addPathMappings(e.factories,n),r)},e.prototype.hasPath=function(e){return this.paths.hasOwnProperty(e)||this.parent_factory&&this.parent_factory.hasPath(e)},e.prototype.addPathMapping=function(e,t){return this.paths[e]=t},e.prototype.addPathMappings=function(e,t){var n,r;for(r in e)n=e[r],this.paths[b.utils.pathJoin(t,r)]=n},e.prototype.hasPathMappings=function(e,t){var n,r,i,s;n=!0;for(s in e)r=e[s],n&=(i=this.creatorForPath(null,b.utils.pathJoin(t,s)))&&r===i;return n},e.prototype.creatorForPath=function(e,t){var n;if(n=this.paths[t])return n.view_model?n.view_model:n;if(this.parent_factory)if(n=this.parent_factory.creatorForPath(e,t))return n;return null},e}(),b.Store=function(){function e(){this.observable_records=[],this.replaced_observables=[]}return e.useOptionsOrCreate=function(e,t,n){return e.store?(e.store.register(t,n,e),b.utils.wrappedStore(n,e.store)):(b.utils.wrappedStoreIsOwned(n,!0),b.utils.wrappedStore(n,new b.Store))},e.prototype.destroy=function(){return this.clear()},e.prototype.clear=function(){var e,t,n,r;r=this.observable_records.splice(0,this.observable_records.length);for(t=0,n=r.length;t<n;t++)e=r[t],b.release(e.observable);b.release(this.replaced_observables)},e.prototype.compact=function(){var e,t,n,r,i;n=[],r=this.observable_records;for(e in r)t=r[e],((i=t.observable)!=null?i.__kb_released:void 0)&&n.push(t);n.length&&(this.observable_records=S.difference(this.observable_records,n))},e.prototype.register=function(e,t,n){var r;if(!t)return;if(w.isObservable(t)||t.__kb_is_co)return;return b.utils.wrappedObject(t,e),e||(t.__kb_null=!0),r=n.creator?n.creator:n.path&&n.factory?n.factory.creatorForPath(e,n.path):null,r||(r=t.constructor),this.observable_records.push({obj:e,observable:t,creator:r}),t},e.prototype.findIndex=function(e,t){var n,r,i,s;i=[];if(!e||e instanceof b.Model){s=this.observable_records;for(n in s){r=s[n];if(!r.observable)continue;if(r.observable.__kb_released){i.push(r);continue}if(!e&&!r.observable.__kb_null||e&&(r.observable.__kb_null||r.obj!==e))continue;if(r.creator===t||r.creator.create&&r.creator.create===t.create)return i.length?(this.observable_records=S.difference(this.observable_records,i),S.indexOf(this.observable_records,r)):n}}return i.length&&(this.observable_records=S.difference(this.observable_records,i)),-1},e.prototype.find=function(e,t){var n;return(n=this.findIndex(e,t))<0?null:this.observable_records[n].observable},e.prototype.isRegistered=function(e){var t,n,r,i;i=this.observable_records;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.observable===e)return!0}return!1},e.prototype.findOrCreate=function(e,t){var n,r;return t.store=this,t.creator||(t.creator=b.utils.inferCreator(e,t.factory,t.path)),!t.creator&&e instanceof b.Model&&(t.creator=b.ViewModel),n=t.creator,n?n.models_only?e:(n&&(r=this.find(e,n)),r?r:(r=b.ignore(function(i){return function(){return n.create?r=n.create(e,t):r=new n(e,t),r||w.observable(null)}}(this)),w.isObservable(r)||this.isRegistered(r)||this.register(e,r,t),r)):b.utils.createFromDefaultCreator(e,t)},e.prototype.findOrReplace=function(e,t,n){var r,i;return e||I(this,"obj missing"),(r=this.findIndex(e,t))<0?this.register(e,n,{creator:t}):(i=this.observable_records[r],b.utils.wrappedObject(i.observable)===e||I(this,"different object"),i.observable!==n&&(i.observable.constructor===n.constructor||I(this,"replacing different type"),this.replaced_observables.push(i.observable),i.observable=n),n)},e}(),b.EventWatcher=function(){function e(e,t,n){this._onModelUnloaded=z(this._onModelUnloaded,this),this._onModelLoaded=z(this._onModelLoaded,this),this.__kb||(this.__kb={}),this.__kb.callbacks={},this.__kb._onModelLoaded=S.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=S.bind(this._onModelUnloaded,this),n&&this.registerCallbacks(t,n),e?this.emitter(e):this.ee=null}return e.useOptionsOrCreate=function(e,t,n,r){return e.event_watcher?(e.event_watcher.emitter()!==t&&e.event_watcher.model_ref!==t&&I(this,"emitter not matching"),b.utils.wrappedEventWatcher(n,e.event_watcher).registerCallbacks(n,r)):(b.utils.wrappedEventWatcherIsOwned(n,!0),b.utils.wrappedEventWatcher(n,new b.EventWatcher(t)).registerCallbacks(n,r))},e.prototype.destroy=function(){return this.emitter(null),this.__kb.callbacks=null,b.utils.wrappedDestroy(this)},e.prototype.emitter=function(e){var t,n,r,i,s,o,u,a;if(arguments.length===0||this.ee===e)return this.ee;this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),b.Backbone&&b.Backbone.ModelRef&&e instanceof b.Backbone.ModelRef?(this.model_ref=e,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),e=this.model_ref.model()):delete this.model_ref,s=this.ee,this.ee=e,a=this.__kb.callbacks;for(n in a){t=a[n],s&&s.unbind(n,t.fn),e&&this.ee.bind(n,t.fn),i=t.list;for(o=0,u=i.length;o<u;o++)r=i[o],r.emitter&&r.emitter(this.ee)}return e},e.prototype.registerCallbacks=function(e,t){var n,r,i,s,o,u,a,f;e||F(this,"obj"),t||F(this,"info"),s=t.event_selector?t.event_selector:"change",i=s.split(" ");for(a=0,f=i.length;a<f;a++){r=i[a];if(!r)continue;n=this.__kb.callbacks[r],n||(u=[],n={list:u,fn:function(e){return function(e){var t,n,i;for(n=0,i=u.length;n<i;n++){t=u[n];if(t.update&&!t.rel_fn){if(e&&t.key&&e.hasChanged&&!e.hasChanged(R(t.key)))continue;!b.statistics||b.statistics.addModelEvent({name:r,model:e,key:t.key,path:t.path}),t.update()}}return null}}(this)},this.__kb.callbacks[r]=n,this.ee&&this.ee.bind(r,n.fn)),o=S.defaults({obj:e},t),n.list.push(o)}this.ee&&(W.call(i,"change")>=0&&(o.unbind_fn=b.orm.bind(this.ee,o.key,o.update,o.path)),o.emitter(this.ee)&&o.emitter)},e.prototype.releaseCallbacks=function(e){var t,n,r,i,s,o;if(!this.__kb.callbacks||!this.ee)return;s=this.__kb.callbacks;for(n in s){t=s[n],o=t.list;for(r in o){i=o[r];if(i.obj!==e)continue;t.list.splice(r,1),i.unbind_fn&&(i.unbind_fn(),i.unbind_fn=null),!b.wasReleased(e)&&i.emitter&&i.emitter(null);return}}},e.prototype._onModelLoaded=function(e){var t,n,r,i,s,o,u;this.ee=e,o=this.__kb.callbacks;for(n in o){t=o[n],e.bind(n,t.fn),u=t.list;for(i=0,s=u.length;i<s;i++)r=u[i],r.unbind_fn=b.orm.bind(e,r.key,r.update,r.path),r.emitter&&r.emitter(e)}},e.prototype._onModelUnloaded=function(e){var t,n,r,i,s,o,u;this.ee=null,u=this.__kb.callbacks;for(n in u){t=u[n],e.unbind(n,t.fn),i=t.list;for(s=0,o=i.length;s<o;s++)r=i[s],r.unbind_fn&&(r.unbind_fn(),r.unbind_fn=null),r.emitter&&r.emitter(null)}},e}(),b.emitterObservable=function(e,t){return new b.EventWatcher(e,t)},b.Observable=function(){function e(e,t,n){return this._vm=n!=null?n:{},b.ignore(function(n){return function(){var r,i,s;return t||F(n,"options"),S.isString(t)||w.isObservable(t)?r=n.create_options={key:t}:r=n.create_options=N(t),n.key=r.key,delete r.key,n.key||F(n,"key"),!r.args||(n.args=r.args,delete r.args),!r.read||(n.read=r.read,delete r.read),!r.write||(n.write=r.write,delete r.write),i=r.event_watcher,delete r.event_watcher,n._vo=w.observable(null),n._model=w.observable(),s=b.utils.wrappedObservable(n,w.dependentObservable({read:function(){var e,t,r,i,s,o;s=n._model(),o=t=[n.key].concat(n.args||[]);for(r=0,i=o.length;r<i;r++)e=o[r],R(e);return n.read?n.update(n.read.apply(n._vm,t)):S.isUndefined(s)||b.ignore(function(){return n.update(b.getValue(s,P(n.key),n.args))}),R(n._vo())},write:function(e){return b.ignore(function(){var t,r;return t=q(e),r=P(n._model),n.write?(n.write.call(n._vm,t),e=b.getValue(r,P(n.key),n.args)):r&&b.setValue(r,P(n.key),t),n.update(e)})},owner:n._vm})),s.__kb_is_o=!0,r.store=b.utils.wrappedStore(s,r.store),r.path=b.utils.pathJoin(r.path,n.key),r.factories&&(typeof r.factories=="function"||r.factories.create)?(r.factory=b.utils.wrappedFactory(s,new b.Factory(r.factory)),r.factory.addPathMapping(r.path,r.factories)):r.factory=b.Factory.useOptionsOrCreate(r,s,r.path),delete r.factories,H(s,n,["value","valueType","destroy"]),s.model=n.model=w.dependentObservable({read:function(){return R(n._model)},write:function(e){return b.ignore(function(){var t;if(n.__kb_released||P(n._model)===e)return;t=b.getValue(e,P(n.key),n.args),n._model(e);if(!e)return n.update(null);if(!S.isUndefined(t))return n.update(t)})}}),b.EventWatcher.useOptionsOrCreate({event_watcher:i},e,n,{emitter:n.model,update:S.bind(n.update,n),key:n.key,path:r.path}),n.__kb_value||n.update(),b.LocalizedObservable&&r.localizer&&(s=new r.localizer(s),delete r.localizer),b.DefaultObservable&&r.hasOwnProperty("default")&&(s=b.defaultObservable(s,r["default"]),delete r["default"]),s}}(this))}return e.prototype.destroy=function(){var e;return e=b.utils.wrappedObservable(this),this.__kb_released=!0,b.release(this.__kb_value),this.__kb_value=null,this.model.dispose(),this.model=e.model=null,b.utils.wrappedDestroy(this)},e.prototype.value=function(){return this.__kb_value},e.prototype.valueType=function(){var e;return e=b.getValue(P(this._model),P(this.key)),this.value_type||this._updateValueObservable(e),this.value_type},e.prototype.update=function(e){var t,n;if(this.__kb_released)return;arguments.length||(e=b.getValue(P(this._model),P(this.key))),e!==void 0||(e=null),t=b.utils.valueType(e);if(!this.__kb_value||this.__kb_value.__kb_released||this.__kb_value.__kb_null&&e)this.__kb_value=void 0,this.value_type=void 0;n=this.__kb_value;if(S.isUndefined(this.value_type)||this.value_type!==t&&t!==f)return this.value_type===o&&t===s?n(e):this._updateValueObservable(e);if(this.value_type===u){if(typeof n.model=="function"){if(n.model()!==e)return n.model(e)}else if(b.utils.wrappedObject(n)!==e)return this._updateValueObservable(e)}else if(this.value_type===o){if(n.collection()!==e)return n.collection(e)}else if(n()!==e)return n(e)},e.prototype._updateValueObservable=function(e){var t,n,r,i;return t=this.create_options,t.creator=b.utils.inferCreator(e,t.factory,t.path,P(this._model),this.key),this.value_type=f,n=t.creator,r=this.__kb_value,this.__kb_value=void 0,r&&b.release(r),n?t.store?i=t.store.findOrCreate(e,t):n.models_only?(i=e,this.value_type=a):n.create?i=n.create(e,t):i=new n(e,t):S.isArray(e)?(this.value_type=s,i=w.observableArray(e)):(this.value_type=a,i=w.observable(e)),this.value_type===f&&(w.isObservable(i)?i.__kb_is_co?this.value_type=o:this.value_type=a:(this.value_type=u,typeof i.model!="function"&&b.utils.wrappedObject(i,e))),this.__kb_value=i,this._vo(i)},e}(),b.observable=function(e,t,n){return new b.Observable(e,t,n)},b.ViewModel=function(){function e(e,t,n){return b.ignore(function(r){return function(){var i,s,o,u,a,f,l,c,h,p;!e||e instanceof b.Model||typeof e.get=="function"&&typeof e.bind=="function"||I(r,"not a model"),t||(t={}),n||(n={}),S.isArray(t)?t={keys:t}:t=N(t),r.__kb||(r.__kb={}),r.__kb.vm_keys={},r.__kb.model_keys={},r.__kb.view_model=S.isUndefined(n)?r:n,!t.internals||(r.__kb.internals=t.internals),!t.excludes||(r.__kb.excludes=t.excludes),!t.statics||(r.__kb.statics=t.statics),!t.static_defaults||(r.__kb.static_defaults=t.static_defaults),b.Store.useOptionsOrCreate(t,e,r),r.__kb.path=t.path,b.Factory.useOptionsOrCreate(t,r,t.path),h=U(r,"_mdl",w.observable()),r.model=w.dependentObservable({read:function(){return h(),b.utils.wrappedObject(r)},write:function(e){return b.ignore(function(){var t,n,i,s;if(b.utils.wrappedObject(r)===e)return;if(r.__kb_null){!e||I(r,"model set on shared null");return}b.utils.wrappedObject(r,e),t=b.utils.wrappedEventWatcher(r);if(!t){h(e);return}t.emitter(e),r.__kb.keys||!e||!e.attributes||(n=S.keys(e.attributes),e&&(s=b.orm.keys(e))&&(n=S.union(n,s)),i=S.difference(n,S.keys(r.__kb.model_keys)),i&&r.createObservables(e,i)),h(e)})}}),o=b.utils.wrappedEventWatcher(r,new b.EventWatcher(e,r,{emitter:r.model})),u=t.requires,r.__kb.internals&&(u=S.union(u||[],r.__kb.internals)),e&&(l=b.orm.keys(e))&&(u=S.union(u||[],l));if(t.keys)if(S.isObject(t.keys)&&!S.isArray(t.keys)){a={},p=t.keys;for(c in p)f=p[c],a[S.isString(f)?f:f.key?f.key:c]=!0;r.__kb.keys=S.keys(a)}else r.__kb.keys=t.keys,u=u?S.union(u,r.__kb.keys):S.clone(r.__kb.keys);else s=o.emitter(),s&&s.attributes&&(i=S.keys(s.attributes),u=u?S.union(u,i):i);return u&&r.__kb.excludes&&(u=S.difference(u,r.__kb.excludes)),u&&r.__kb.statics&&(u=S.difference(u,r.__kb.statics)),S.isObject(t.keys)&&!S.isArray(t.keys)&&r.mapObservables(e,t.keys),S.isObject(t.requires)&&!S.isArray(t.requires)&&r.mapObservables(e,t.requires),!t.mappings||r.mapObservables(e,t.mappings),!u||r.createObservables(e,u),!r.__kb.statics||r.createObservables(e,r.__kb.statics,!0),!b.statistics||b.statistics.register("ViewModel",r),r}}(this))}return e.extend=b.extend,e.prototype.destroy=function(){var e;if(this.__kb.view_model!==this)for(e in this.__kb.vm_keys)this.__kb.view_model[e]=null;return this.__kb.view_model=null,b.releaseKeys(this),b.utils.wrappedDestroy(this),!b.statistics||b.statistics.unregister("ViewModel",this)},e.prototype.shareOptions=function(){return{store:b.utils.wrappedStore(this),factory:b.utils.wrappedFactory(this)}},e.prototype.createObservables=function(e,t,n){var r,i,s,o,u,a;n?s=this.__kb.static_defaults||{}:r={store:b.utils.wrappedStore(this),factory:b.utils.wrappedFactory(this),path:this.__kb.path,event_watcher:b.utils.wrappedEventWatcher(this)};for(u=0,a=t.length;u<a;u++){i=t[u],o=this.__kb.internals&&S.contains(this.__kb.internals,i)?"_"+i:i;if(this[o])continue;this.__kb.vm_keys[o]=this.__kb.model_keys[i]=!0,n?e.has(o)?this[o]=this.__kb.view_model[o]=e.get(o):o in s&&(this[o]=this.__kb.view_model[o]=s[o]):(r.key=i,this[o]=this.__kb.view_model[o]=b.observable(e,r,this))}},e.prototype.mapObservables=function(e,t){var n,r,i;n={store:b.utils.wrappedStore(this),factory:b.utils.wrappedFactory(this),path:this.__kb.path,event_watcher:b.utils.wrappedEventWatcher(this)};for(i in t){r=t[i];if(this[i])continue;r=S.isString(r)?{key:r}:S.clone(r),r.key||(r.key=i),this.__kb.vm_keys[i]=this.__kb.model_keys[r.key]=!0,this[i]=this.__kb.view_model[i]=b.observable(e,S.defaults(r,n),this)}},e}(),b.viewModel=function(e,t,n){return new b.ViewModel(e,t,n)},r=0,t=-1,n=1,b.compare=function(e,i){return S.isString(e)?e.localeCompare(""+i):S.isString(i)?i.localeCompare(""+e):e===i?r:e<i?t:n},b.CollectionObservable=function(){function e(e,t){return b.ignore(function(n){return function(){var r,i,s;return!S.isUndefined(t)||e instanceof b.Collection?S.isArray(e)&&(e=new b.Collection(e)):(s=[new b.Collection,e],e=s[0],t=s[1]),t||(t={}),i=b.utils.wrappedObservable(n,w.observableArray([])),i.__kb_is_co=!0,n.in_edit=0,n.__kb||(n.__kb={}),n.__kb._onCollectionChange=S.bind(n._onCollectionChange,n),t=N(t),t.auto_compact&&(n.auto_compact=!0),t.sort_attribute?n._comparator=w.observable(n._attributeComparator(t.sort_attribute)):n._comparator=w.observable(t.comparator),t.filters?n._filters=w.observableArray(S.isArray(t.filters)?t.filters:t.filters?[t.filters]:void 0):n._filters=w.observableArray([]),r=n.create_options={store:b.Store.useOptionsOrCreate(t,e,i)},n.path=t.path,r.factory=b.utils.wrappedFactory(i,n._shareOrCreateFactory(t)),r.path=b.utils.pathJoin(t.path,"models"),r.creator=r.factory.creatorForPath(null,r.path),r.creator&&(n.models_only=r.creator.models_only),H(i,n,["destroy","shareOptions","filters","comparator","sortAttribute","viewModelByModel","hasViewModels"]),n._collection=w.observable(e),i.collection=n.collection=w.dependentObservable({read:function(){return n._collection()},write:function(e){return b.ignore(function(){var t;if((t=n._collection())===e)return;return t&&t.unbind("all",n.__kb._onCollectionChange),e&&e.bind("all",n.__kb._onCollectionChange),n._collection(e)})}}),e&&e.bind("all",n.__kb._onCollectionChange),n._mapper=w.dependentObservable(function(){var e,t,r,s,o,u,a,f;e=n._comparator(),s=n._filters();if(s)for(a=0,f=s.length;a<f;a++)r=s[a],R(r);t=n._collection();if(n.in_edit)return;return i=b.utils.wrappedObservable(n),t&&(o=t.models),!o||t.models.length===0?u=[]:(o=S.filter(o,function(e){return!s.length||n._selectModel(e)}),e?u=S.map(o,function(e){return n._createViewModel(e)}).sort(e):n.models_only?u=s.length?o:o.slice():u=S.map(o,function(e){return n._createViewModel(e)})),n.in_edit++,i(u),n.in_edit--}),i.subscribe(S.bind(n._onObservableArrayChange,n)),!b.statistics||b.statistics.register("CollectionObservable",n),i}}(this))}return e.extend=b.extend,e.prototype.destroy=function(){var e,t,n;return n=b.utils.wrappedObservable(this),t=this._collection(),t&&(t.unbind("all",this.__kb._onCollectionChange),e=n(),e.splice(0,e.length)),this.collection.dispose(),this._collection=n.collection=this.collection=null,this._mapper.dispose(),this._mapper=null,b.release(this._filters),this._filters=null,this._comparator(null),this._comparator=null,this.create_options=null,n.collection=null,b.utils.wrappedDestroy(this),!b.statistics||b.statistics.unregister("CollectionObservable",this)},e.prototype.shareOptions=function(){var e;return e=b.utils.wrappedObservable(this),{store:b.utils.wrappedStore(e),factory:b.utils.wrappedFactory(e)}},e.prototype.filters=function(e){return e?this._filters(S.isArray(e)?e:[e]):this._filters([])},e.prototype.comparator=function(e){return this._comparator(e)},e.prototype.sortAttribute=function(e){return this._comparator(e?this._attributeComparator(e):null)},e.prototype.viewModelByModel=function(e){var t;return this.models_only?null:(t=e.hasOwnProperty(e.idAttribute)?e.idAttribute:"cid",S.find(P(b.utils.wrappedObservable(this)),function(n){var r;return(n!=null?(r=n.__kb)!=null?r.object:void 0:void 0)?n.__kb.object[t]===e[t]:!1}))},e.prototype.hasViewModels=function(){return!this.models_only},e.prototype.compact=function(){return b.ignore(function(e){return function(){var t;t=b.utils.wrappedObservable(e);if(!b.utils.wrappedStoreIsOwned(t))return;return b.utils.wrappedStore(t).clear(),e._collection.notifySubscribers(e._collection())}}(this))},e.prototype._shareOrCreateFactory=function(e){var t,n,r,i;t=b.utils.pathJoin(e.path,"models"),r=e.factories;if(i=e.factory)if((n=i.creatorForPath(null,t))&&(!r||r.models===n)){if(!r)return i;if(i.hasPathMappings(r,e.path))return i}return i=new b.Factory(e.factory),r&&i.addPathMappings(r,e.path),i.creatorForPath(null,t)||(e.hasOwnProperty("models_only")?e.models_only?i.addPathMapping(t,{models_only:!0}):i.addPathMapping(t,b.ViewModel):e.view_model?i.addPathMapping(t,e.view_model):e.create?i.addPathMapping(t,{create:e.create}):i.addPathMapping(t,b.ViewModel)),i},e.prototype._onCollectionChange=function(e,t){return b.ignore(function(n){return function(){var r,i,s,o;if(n.in_edit)return;switch(e){case"reset":n.auto_compact?n.compact():n._collection.notifySubscribers(n._collection());break;case"sort":case"resort":n._collection.notifySubscribers(n._collection());break;case"new":case"add":if(!n._selectModel(t))return;s=b.utils.wrappedObservable(n),r=n._collection();if(r.indexOf(t)===-1)return;if(o=n.viewModelByModel(t))return;n.in_edit++,o=n._createViewModel(t),(i=n._comparator())?(s().push(o),s.sort(i)):s.splice(r.indexOf(t),0,o),n.in_edit--;break;case"remove":case"destroy":n._onModelRemove(t);break;case"change":if(!n._selectModel(t))n._onModelRemove(t);else{o=n.models_only?t:n.viewModelByModel(t);if(o){if(i=n._comparator())s=b.utils.wrappedObservable(n),n.in_edit++,s.sort(i),n.in_edit--}else n._onCollectionChange("add",t)}}}}(this))},e.prototype._onModelRemove=function(e){var t,n;n=this.models_only?e:this.viewModelByModel(e);if(!n)return;return t=b.utils.wrappedObservable(this),this.in_edit++,t.remove(n),this.in_edit--},e.prototype._onObservableArrayChange=function(e){return b.ignore(function(t){return function(){var n,r,i,s,o,u,a,f,l;if(t.in_edit)return;t.models_only&&(!e.length||b.utils.hasModelSignature(e[0]))||!t.models_only&&(!e.length||S.isObject(e[0])&&!b.utils.hasModelSignature(e[0]))||I(t,"incorrect type passed"),o=b.utils.wrappedObservable(t),n=P(t._collection),r=P(t._filters).length;if(!n)return;a=e;if(t.models_only)s=S.filter(e,function(e){return!r||t._selectModel(e)});else{!r||(a=[]),s=[];for(f=0,l=e.length;f<l;f++){u=e[f],i=b.utils.wrappedObject(u);if(r){if(!t._selectModel(i))continue;a.push(u)}t.create_options.store.findOrReplace(i,t.create_options.creator,u),s.push(i)}}t.in_edit++,e.length===a.length||o(a),S.isEqual(n.models,s)||n.reset(s),t.in_edit--}}(this))},e.prototype._attributeComparator=function(e){var t;return t=function(t,n){var r;return r=R(e),b.compare(t.get(r),n.get(r))},this.models_only?t:function(e,n){return t(b.utils.wrappedModel(e),b.utils.wrappedModel(n))}},e.prototype._createViewModel=function(e){return this.models_only?e:this.create_options.store.findOrCreate(e,this.create_options)},e.prototype._selectModel=function(e){var t,n,r,i,s;n=P(this._filters);for(r=0,i=n.length;r<i;r++){t=n[r],t=P(t);if(S.isFunction(t)){if(!t(e))return!1}else if(S.isArray(t)){if(s=e.id,W.call(t,s)<0)return!1}else if(e.id!==t)return!1}return!0},e}(),b.collectionObservable=function(e,t){return new b.CollectionObservable(e,t)},b.RECUSIVE_AUTO_INJECT=!0,w.bindingHandlers.inject={init:function(e,t,n,r){return b.Inject.inject(R(t()),r,e,t,n)}},b.Inject=function(){function e(){}return e.inject=function(e,t,n,r,i,s){var o,u,a;return o=function(e){var o,u,a;if(S.isFunction(e))t=new e(t,n,r,i),b.releaseOnNodeRemove(t,n);else{e.view_model&&(t=new e.view_model(t,n,r,i),b.releaseOnNodeRemove(t,n));for(o in e){a=e[o];if(o==="view_model")continue;o==="create"?a(t,n,r,i):S.isObject(a)&&!S.isFunction(a)?(u=s||a&&a.create?{}:t,t[o]=b.Inject.inject(a,u,n,r,i,!0)):t[o]=a}}return t},s?o(e):(u=(a=w.dependentObservable(function(){return o(e)}))(),a.dispose(),u)},e.injectViewModels=function(e){var t,n,r,i,s,o,u,a,f,l;a=[],o=function(e){var t,n,r,i,s;e.__kb_injected||e.attributes&&(t=S.find(e.attributes,function(e){return e.name==="kb-inject"}))&&(e.__kb_injected=!0,a.push({el:e,view_model:{},binding:t.value})),s=e.childNodes;for(r=0,i=s.length;r<i;r++)n=s[r],o(n)},!e&&typeof document!="undefined"&&document!==null&&(e=document),o(e);for(f=0,l=a.length;f<l;f++){n=a[f];if(s=n.binding)s.search(/[:]/)<0||(s="{"+s+"}"),i=(new Function("","return ( "+s+" )"))(),i||(i={}),!i.options||(u=i.options,delete i.options),u||(u={}),n.view_model=b.Inject.inject(i,n.view_model,n.el,null,null,!0),t=n.view_model.afterBinding||u.afterBinding,r=n.view_model.beforeBinding||u.beforeBinding;r&&r(n.view_model,n.el,u),b.applyBindings(n.view_model,n.el,u),t&&t(n.view_model,n.el,u)}return a},e}(),A=w.applyBindings,w.applyBindings=function(e,t){var n;n=b.RECUSIVE_AUTO_INJECT?b.injectViewModels(t):[];if(!n.length)return A.apply(this,arguments)},b.injectViewModels=b.Inject.injectViewModels,typeof document!="undefined"&&document!==null&&(this.$?this.$(function(){return b.injectViewModels()}):(E=function(){return document.readyState!=="complete"?setTimeout(E,0):b.injectViewModels()})()),H=b._publishMethods,b.DefaultObservable=function(){function e(e,t){var n;return this.dv=t,n=b.utils.wrappedObservable(this,w.dependentObservable({read:function(t){return function(){var n;return(n=R(e()))?n:R(t.dv)}}(this),write:function(t){return e(t)}})),H(n,this,["destroy","setToDefault"]),n}return e.prototype.destroy=function(){return b.utils.wrappedDestroy(this)},e.prototype.setToDefault=function(){return b.utils.wrappedObservable(this)(this.dv)},e}(),b.defaultObservable=function(e,t){return new b.DefaultObservable(e,t)},b.Observable.prototype.setToDefault=function(){var e;(e=this.__kb_value)!=null&&typeof e.setToDefault=="function"&&e.setToDefault()},b.ViewModel.prototype.setToDefault=function(){var e,t;for(e in this.__kb.vm_keys)(t=this[e])!=null&&typeof t.setToDefault=="function"&&t.setToDefault()},b.utils.setToDefault=function(e){var t,n;if(!e)return;if(w.isObservable(e))typeof e.setToDefault=="function"&&e.setToDefault();else if(S.isObject(e))for(t in e)n=e[t],n&&(w.isObservable(n)||typeof n!="function")&&(t[0]!=="_"||t.search("__kb"))&&this.setToDefault(n);return e},m=Array.prototype.slice,b.toFormattedString=function(e){var t,n,r,i,s,o;s=e.slice(),n=m.call(arguments,1);for(r in n){t=n[r],o=R(t);if(S.isUndefined(o)||S.isNull(o))o="";i=e.indexOf("{"+r+"}");while(i>=0)s=s.replace("{"+r+"}",o),i=e.indexOf("{"+r+"}",i+1)}return s},b.parseFormattedString=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d;c=t.slice(),i=0,u=0,f={};while(c.search("\\{"+i+"\\}")>=0){a=t.indexOf("{"+i+"}");while(a>=0)c=c.replace("{"+i+"}","(.*)"),f[a]=i,u++,a=t.indexOf("{"+i+"}",a+1);i++}n=i,l=new RegExp(c),o=l.exec(e),o&&o.shift();if(!o||o.length!==u){h=[];while(n-->0)h.push("");return h}d=S.sortBy(S.keys(f),function(e,t){return parseInt(e,10)}),r={};for(s in d){a=d[s],i=f[a];if(r.hasOwnProperty(i))continue;r[i]=s}p=[],i=0;while(i<n)p.push(o[r[i]]),i++;return p},b.FormattedObservable=function(){function e(e,t){var n,r;return S.isArray(t)?(e=e,r=t):r=m.call(arguments,1),n=b.utils.wrappedObservable(this,w.dependentObservable({read:function(){var n,i,s;t=[R(e)];for(i=0,s=r.length;i<s;i++)n=r[i],t.push(R(n));return b.toFormattedString.apply(null,t)},write:function(t){var n,i,s;i=b.parseFormattedString(t,R(e)),s=Math.min(r.length,i.length),n=0;while(n<s)r[n](i[n]),n++}})),n}return e.prototype.destroy=function(){return b.utils.wrappedDestroy(this)},e}(),b.formattedObservable=function(e,t){return new b.FormattedObservable(e,m.call(arguments,1))},H=b._publishMethods,b.LocalizedObservable=function(){function e(e,t,n){var r;return this.value=e,this.vm=n,t||(t={}),this.vm||(this.vm={}),this.read||F(this,"read"),b.locale_manager||F(this,"kb.locale_manager"),this.__kb||(this.__kb={}),this.__kb._onLocaleChange=S.bind(this._onLocaleChange,this),this.__kb._onChange=t.onChange,this.value&&(e=R(this.value)),this.vo=w.observable(e?this.read(e,null):null),r=b.utils.wrappedObservable(this,w.dependentObservable({read:function(e){return function(){return e.value&&R(e.value),e.vo(),e.read(R(e.value))}}(this),write:function(e){return function(t){e.write||I(e,"writing to read-only"),e.write(t,R(e.value)),e.vo(t);if(e.__kb._onChange)return e.__kb._onChange(t)}}(this),owner:this.vm})),H(r,this,["destroy","observedValue","resetToCurrent"]),b.locale_manager.bind("change",this.__kb._onLocaleChange),t.hasOwnProperty("default")&&(r=b.DefaultObservable&&w.defaultObservable(r,t["default"])),r}return e.extend=b.extend,e.prototype.destroy=function(){return b.locale_manager.unbind("change",this.__kb._onLocaleChange),this.vm=null,b.utils.wrappedDestroy(this)},e.prototype.resetToCurrent=function(){var e,t;t=b.utils.wrappedObservable(this),e=this.value?this.read(R(this.value)):null;if(t()===e)return;return t(e)},e.prototype.observedValue=function(e){if(arguments.length===0)return this.value;this.value=e,this._onLocaleChange()},e.prototype._onLocaleChange=function(){var e;e=this.read(R(this.value)),this.vo(e);if(this.__kb._onChange)return this.__kb._onChange(e)},e}(),b.localizedObservable=function(e,t,n){return new b.LocalizedObservable(e,t,n)},b.locale_manager=void 0,H=b._publishMethods,b.TriggeredObservable=function(){function e(e,t){var n;return this.event_selector=t,e||F(this,"emitter"),this.event_selector||F(this,"event_selector"),this.vo=w.observable(),n=b.utils.wrappedObservable(this,w.dependentObservable(function(e){return function(){return e.vo()}}(this))),H(n,this,["destroy"]),b.utils.wrappedEventWatcher(this,new b.EventWatcher(e,this,{emitter:S.bind(this.emitter,this),update:S.bind(this.update,this),event_selector:this.event_selector})),n}return e.prototype.destroy=function(){return b.utils.wrappedDestroy(this)},e.prototype.emitter=function(e){if(arguments.length===0||this.ee===e)return this.ee;if(this.ee=e)return this.update()},e.prototype.update=function(){if(!this.ee)return;return this.vo()!==this.ee?this.vo(this.ee):this.vo.valueHasMutated()},e}(),b.triggeredObservable=function(e,t){return new b.TriggeredObservable(e,t)},g=function(e){return e=R(e),typeof e=="function"?e.apply(null,Array.prototype.slice.call(arguments,1)):e},b.Validation=function(){function e(){}return e}(),b.valueValidator=function(e,t,n){return n==null&&(n={}),n&&typeof n!="function"||(n={}),w.dependentObservable(function(){var r,i,s,o,u,a,f,l;f={$error_count:0},i=R(e),!("disable"in n)||(s=g(n.disable)),!("enable"in n)||(s=!g(n.enable)),a=n.priorities||[],S.isArray(a)||(a=[a]),r=a.length+1;for(o in t)l=t[o],f[o]=!s&&g(l,i),f[o]&&(f.$error_count++,(u=S.indexOf(a,o)>=0)||(u=a.length),f.$active_error&&u<r?(f.$active_error=o,r=u):f.$active_error||(f.$active_error=o,r=u));return f.$enabled=!s,f.$disable=!!s,f.$valid=f.$error_count===0,f})},b.inputValidator=function(e,t,n){var r,i,s,o,u,a,f,l,c,h;n==null&&(n={}),n&&typeof n!="function"||(n={}),c=b.valid,r=$(t),(o=r.attr("name"))&&!S.isString(o)&&(o=null);if(!(i=r.attr("data-bind")))return null;u=(new Function("sc","with(sc[0]) { return { "+i+" } }"))([e]);if(!u||!u.value)return null;!u.validation_options||(S.defaults(u.validation_options,n),n=u.validation_options),i={},!c[f=r.attr("type")]||(i[f]=c[f]),!r.attr("required")||(i.required=c.required);if(u.validations){h=u.validations;for(s in h)l=h[s],i[s]=l}return a=b.valueValidator(u.value,i,n),!o&&!n.no_attach||(e["$"+o]=a),a},b.formValidator=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d;a={},c=[],n=$(t),(i=n.attr("name"))&&!S.isString(i)&&(i=null);if(r=n.attr("data-bind"))u=(new Function("sc","with(sc[0]) { return { "+r+" } }"))([e]),f=u.validation_options;f||(f={}),f.no_attach=!!i,d=n.find("input");for(h=0,p=d.length;h<p;h++){s=d[h];if(!(o=$(s).attr("name")))continue;l=b.inputValidator(e,s,f),!l||c.push(a[o]=l)}return a.$error_count=w.dependentObservable(function(){var e,t,n;e=0;for(t=0,n=c.length;t<n;t++)l=c[t],e+=l().$error_count;return e}),a.$valid=w.dependentObservable(function(){return a.$error_count()===0}),a.$enabled=w.dependentObservable(function(){var e,t,n;e=!0;for(t=0,n=c.length;t<n;t++)l=c[t],e&=l().$enabled;return e}),a.$disabled=w.dependentObservable(function(){return!a.$enabled()}),i&&(e["$"+i]=a),a},v=/^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/,i=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}$/,l=/^\s*(\-|\+)?(\d+|(\d*(\.\d*)))\s*$/,b.valid={required:function(e){return!e},url:function(e){return!v.test(e)},email:function(e){return!i.test(e)},number:function(e){return!l.test(e)}},b.hasChangedFn=function(e){var t,n;return n=null,t=null,function(){var r;return n!==(r=R(e))?(n=r,t=n?n.toJSON():null,!1):!n||!t?!1:!S.isEqual(n.toJSON(),t)}},b.minLengthFn=function(e){return function(t){return!t||t.length<e}},b.uniqueValueFn=function(e,t,n){return function(r){var i,s,o;return o=R(e),s=R(t),i=R(n),o&&s&&i?!!S.find(i.models,function(e){return function(e){return e!==o&&e.get(s)===r}}(this)):!1}},b.untilTrueFn=function(e,t,n){var r;return r=!1,n&&w.isObservable(n)&&n.subscribe(function(){return r=!1}),function(n){var i,s;return(i=R(t))?(r|=!!(s=i(R(n))),r?s:R(e)):R(e)}},b.untilFalseFn=function(e,t,n){var r;return r=!1,n&&w.isObservable(n)&&n.subscribe(function(){return r=!1}),function(n){var i,s;return(i=R(t))?(r|=!(s=i(R(n))),r?s:R(e)):R(e)}},b})}).call(this);